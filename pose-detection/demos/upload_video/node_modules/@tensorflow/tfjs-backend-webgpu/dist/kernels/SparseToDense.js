/**
 * @license
 * Copyright 2021 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
import { backend_util, SparseToDense, util } from '@tensorflow/tfjs-core';
import { scatterImplCPU } from '../kernel_utils/shared';
import { ScatterProgram } from '../scatter_webgpu';
import { identity } from './Identity';
import { reshape } from './Reshape';
import { tile } from './Tile';
export function sparseToDense(args) {
    const { inputs, backend, attrs } = args;
    const { sparseIndices, sparseValues, defaultValue } = inputs;
    const { outputShape } = attrs;
    const { sliceRank, numUpdates, sliceSize, strides, outputSize } = backend_util.calculateShapes(sparseValues, sparseIndices, outputShape);
    const sumDupeIndices = false;
    if (sparseValues.dtype === 'string') {
        const indicesBuf = backend.bufferSync(sparseIndices);
        const updatesBuf = backend.bufferSync(sparseValues);
        const $defaultValue = util.decodeString(backend.readSync(defaultValue.dataId)[0]);
        const outBuf = scatterImplCPU(indicesBuf, updatesBuf, outputShape, outputSize, sliceSize, numUpdates, sliceRank, strides, $defaultValue, sumDupeIndices);
        return backend.makeTensorInfo(outputShape, outBuf.dtype, outBuf.values);
    }
    const flattenShape = [outputSize / sliceSize, sliceSize];
    const $sparseIndices = reshape({
        inputs: { x: sparseIndices },
        backend,
        attrs: { shape: [numUpdates, sliceRank] }
    });
    const $sparseValues = sparseValues.shape.length ?
        reshape({
            inputs: { x: sparseValues },
            backend,
            attrs: { shape: [numUpdates, sliceSize] }
        }) :
        identity({ inputs: { x: sparseValues }, backend });
    const type = $sparseValues.dtype;
    const zero = backend.makeTensorInfo([], type, util.makeZerosTypedArray(1, type));
    // Fill output tensor with the default value.
    const $defaultValue = reshape({
        inputs: { x: defaultValue },
        backend,
        attrs: { shape: Array(flattenShape.length).fill(1) }
    });
    const $denseValues = tile({ inputs: { x: $defaultValue }, backend, attrs: { reps: flattenShape } });
    const size = util.sizeFromShape([numUpdates, sliceSize]);
    const uniformData = [
        { type: 'int32', data: [sliceRank] },
        { type: 'int32', data: strides },
        { type: 'int32', data: [size] },
    ];
    switch (numUpdates) {
        case 0:
            break;
        case 1:
            if (true) {
                const program = new ScatterProgram([numUpdates, sliceSize], sliceRank, $sparseIndices.shape.length, $sparseValues.shape.length, strides, flattenShape, type, sumDupeIndices);
                backend.runWebGPUProgram(program, [$sparseValues, $sparseIndices], type, uniformData, $denseValues);
            }
            break;
        default:
            if (true) {
                // First replace the default value with 0 at indices.
                const program = new ScatterProgram([numUpdates, sliceSize], sliceRank, $sparseIndices.shape.length, zero.shape.length, strides, flattenShape, type, sumDupeIndices);
                backend.runWebGPUProgram(program, [zero, $sparseIndices], type, uniformData, $denseValues);
            }
            {
                // Then replace 0 with the (sum of) sparse value(s) at indices.
                const program = new ScatterProgram([numUpdates, sliceSize], sliceRank, $sparseIndices.shape.length, $sparseValues.shape.length, strides, flattenShape, type);
                backend.runWebGPUProgram(program, [$sparseValues, $sparseIndices], type, uniformData, $denseValues);
            }
    }
    const denseValues = reshape({ inputs: { x: $denseValues }, backend, attrs: { shape: outputShape } });
    backend.disposeData($sparseIndices.dataId);
    backend.disposeData($sparseValues.dataId);
    backend.disposeData($defaultValue.dataId);
    backend.disposeData(zero.dataId);
    backend.disposeData($denseValues.dataId);
    return denseValues;
}
export const sparseToDenseConfig = {
    kernelName: SparseToDense,
    backendName: 'webgpu',
    kernelFunc: sparseToDense
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3BhcnNlVG9EZW5zZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3RmanMtYmFja2VuZC13ZWJncHUvc3JjL2tlcm5lbHMvU3BhcnNlVG9EZW5zZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7QUFFSCxPQUFPLEVBQUMsWUFBWSxFQUFrQyxhQUFhLEVBQXVELElBQUksRUFBQyxNQUFNLHVCQUF1QixDQUFDO0FBRzdKLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUN0RCxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sbUJBQW1CLENBQUM7QUFFakQsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLFlBQVksQ0FBQztBQUNwQyxPQUFPLEVBQUMsT0FBTyxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBQ2xDLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxRQUFRLENBQUM7QUFFNUIsTUFBTSxVQUFVLGFBQWEsQ0FBQyxJQUk3QjtJQUNDLE1BQU0sRUFBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBQyxHQUFHLElBQUksQ0FBQztJQUN0QyxNQUFNLEVBQUMsYUFBYSxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUMsR0FBRyxNQUFNLENBQUM7SUFDM0QsTUFBTSxFQUFDLFdBQVcsRUFBQyxHQUFHLEtBQUssQ0FBQztJQUU1QixNQUFNLEVBQUMsU0FBUyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBQyxHQUN6RCxZQUFZLENBQUMsZUFBZSxDQUFDLFlBQVksRUFBRSxhQUFhLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFFM0UsTUFBTSxjQUFjLEdBQUcsS0FBSyxDQUFDO0lBQzdCLElBQUksWUFBWSxDQUFDLEtBQUssS0FBSyxRQUFRLEVBQUU7UUFDbkMsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBZ0IsYUFBYSxDQUFD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Q0o7SUFFRCxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQ3ZCLEVBQUMsTUFBTSxFQUFFLEVBQUMsQ0FBQyxFQUFFLFlBQVksRUFBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBQyxLQUFLLEVBQUUsV0FBVyxFQUFDLEVBQUMsQ0FBQyxDQUFDO0lBRXZFLE9BQU8sQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzNDLE9BQU8sQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2pDLE9BQU8sQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3pDLE9BQU8sV0FBVyxDQUFDO0FBQ3JCLENBQUM7QUFFRCxNQUFNLENBQUMsTUFBTSxtQkFBbUIsR0FBaUI7SUFDL0MsVUFBVSxFQUFFLGFBQWE7SUFDekIsV0FBVyxFQUFFLFFBQVE7SUFDckIsVUFBVSxFQUFFLGFBQXNDO0NBQ25ELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAyMSBHb29nbGUgTExDLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICovXG5cbmltcG9ydCB7YmFja2VuZF91dGlsLCBLZXJuZWxDb25maWcsIEtlcm5lbEZ1bmMsIFJhbmssIFNwYXJzZVRvRGVuc2UsIFNwYXJzZVRvRGVuc2VBdHRycywgU3BhcnNlVG9EZW5zZUlucHV0cywgVGVuc29ySW5mbywgdXRpbH0gZnJvbSAnQHRlbnNvcmZsb3cvdGZqcy1jb3JlJztcblxuaW1wb3J0IHtXZWJHUFVCYWNrZW5kfSBmcm9tICcuLi9iYWNrZW5kX3dlYmdwdSc7XG5pbXBvcnQge3NjYXR0ZXJJbXBsQ1BVfSBmcm9tICcuLi9rZXJuZWxfdXRpbHMvc2hhcmVkJztcbmltcG9ydCB7U2NhdHRlclByb2dyYW19IGZyb20gJy4uL3NjYXR0ZXJfd2ViZ3B1JztcblxuaW1wb3J0IHtpZGVudGl0eX0gZnJvbSAnLi9JZGVudGl0eSc7XG5pbXBvcnQge3Jlc2hhcGV9IGZyb20gJy4vUmVzaGFwZSc7XG5pbXBvcnQge3RpbGV9IGZyb20gJy4vVGlsZSc7XG5cbmV4cG9ydCBmdW5jdGlvbiBzcGFyc2VUb0RlbnNlKGFyZ3M6IHtcbiAgaW5wdXRzOiBTcGFyc2VUb0RlbnNlSW5wdXRzLFxuICBiYWNrZW5kOiBXZWJHUFVCYWNrZW5kLFxuICBhdHRyczogU3BhcnNlVG9EZW5zZUF0dHJzXG59KTogVGVuc29ySW5mbyB7XG4gIGNvbnN0IHtpbnB1dHMsIGJhY2tlbmQsIGF0dHJzfSA9IGFyZ3M7XG4gIGNvbnN0IHtzcGFyc2VJbmRpY2VzLCBzcGFyc2VWYWx1ZXMsIGRlZmF1bHRWYWx1ZX0gPSBpbnB1dHM7XG4gIGNvbnN0IHtvdXRwdXRTaGFwZX0gPSBhdHRycztcblxuICBjb25zdCB7c2xpY2VSYW5rLCBudW1VcGRhdGVzLCBzbGljZVNpemUsIHN0cmlkZXMsIG91dHB1dFNpemV9ID1cbiAgICAgIGJhY2tlbmRfdXRpbC5jYWxjdWxhdGVTaGFwZXMoc3BhcnNlVmFsdWVzLCBzcGFyc2VJbmRpY2VzLCBvdXRwdXRTaGFwZSk7XG5cbiAgY29uc3Qgc3VtRHVwZUluZGljZXMgPSBmYWxzZTtcbiAgaWYgKHNwYXJzZVZhbHVlcy5kdHlwZSA9PT0gJ3N0cmluZycpIHtcbiAgICBjb25zdCBpbmRpY2VzQnVmID0gYmFja2VuZC5idWZmZXJTeW5jPFJhbmssICdpbnQzMic+KHNwYXJzZUluZGljZXMpO1xuICAgIGNvbnN0IHVwZGF0ZXNCdWYgPSBiYWNrZW5kLmJ1ZmZlclN5bmM8UmFuaywgJ3N0cmluZyc+KHNwYXJzZVZhbHVlcyk7XG4gICAgY29uc3QgJGRlZmF1bHRWYWx1ZSA9IHV0aWwuZGVjb2RlU3RyaW5nKFxuICAgICAgICBiYWNrZW5kLnJlYWRTeW5jKGRlZmF1bHRWYWx1ZS5kYXRhSWQpWzBdIGFzIFVpbnQ4QXJyYXkpO1xuICAgIGNvbnN0IG91dEJ1ZiA9IHNjYXR0ZXJJbXBsQ1BVKFxuICAgICAgICBpbmRpY2VzQnVmLCB1cGRhdGVzQnVmLCBvdXRwdXRTaGFwZSwgb3V0cHV0U2l6ZSwgc2xpY2VTaXplLCBudW1VcGRhdGVzLFxuICAgICAgICBzbGljZVJhbmssIHN0cmlkZXMsICRkZWZhdWx0VmFsdWUsIHN1bUR1cGVJbmRpY2VzKTtcbiAgICByZXR1cm4gYmFja2VuZC5tYWtlVGVuc29ySW5mbyhvdXRwdXRTaGFwZSwgb3V0QnVmLmR0eXBlLCBvdXRCdWYudmFsdWVzKTtcbiAgfVxuXG4gIGNvbnN0IGZsYXR0ZW5TaGFwZSA9IFtvdXRwdXRTaXplIC8gc2xpY2VTaXplLCBzbGljZVNpemVdO1xuXG4gIGNvbnN0ICRzcGFyc2VJbmRpY2VzID0gcmVzaGFwZSh7XG4gICAgaW5wdXRzOiB7eDogc3BhcnNlSW5kaWNlc30sXG4gICAgYmFja2VuZCxcbiAgICBhdHRyczoge3NoYXBlOiBbbnVtVXBkYXRlcywgc2xpY2VSYW5rXX1cbiAgfSk7XG4gIGNvbnN0ICRzcGFyc2VWYWx1ZXMgPSBzcGFyc2VWYWx1ZXMuc2hhcGUubGVuZ3RoID9cbiAgICAgIHJlc2hhcGUoe1xuICAgICAgICBpbnB1dHM6IHt4OiBzcGFyc2VWYWx1ZXN9LFxuICAgICAgICBiYWNrZW5kLFxuICAgICAgICBhdHRyczoge3NoYXBlOiBbbnVtVXBkYXRlcywgc2xpY2VTaXplXX1cbiAgICAgIH0pIDpcbiAgICAgIGlkZW50aXR5KHtpbnB1dHM6IHt4OiBzcGFyc2VWYWx1ZXN9LCBiYWNrZW5kfSk7XG5cbiAgY29uc3QgdHlwZSA9ICRzcGFyc2VWYWx1ZXMuZHR5cGU7XG4gIGNvbnN0IHplcm8gPVxuICAgICAgYmFja2VuZC5tYWtlVGVuc29ySW5mbyhbXSwgdHlwZSwgdXRpbC5tYWtlWmVyb3NUeXBlZEFycmF5KDEsIHR5cGUpKTtcblxuICAvLyBGaWxsIG91dHB1dCB0ZW5zb3Igd2l0aCB0aGUgZGVmYXVsdCB2YWx1ZS5cbiAgY29uc3QgJGRlZmF1bHRWYWx1ZSA9IHJlc2hhcGUoe1xuICAgIGlucHV0czoge3g6IGRlZmF1bHRWYWx1ZX0sXG4gICAgYmFja2VuZCxcbiAgICBhdHRyczoge3NoYXBlOiBBcnJheShmbGF0dGVuU2hhcGUubGVuZ3RoKS5maWxsKDEpfVxuICB9KTtcbiAgY29uc3QgJGRlbnNlVmFsdWVzID1cbiAgICAgIHRpbGUoe2lucHV0czoge3g6ICRkZWZhdWx0VmFsdWV9LCBiYWNrZW5kLCBhdHRyczoge3JlcHM6IGZsYXR0ZW5TaGFwZX19KTtcblxuICBjb25zdCBzaXplID0gdXRpbC5zaXplRnJvbVNoYXBlKFtudW1VcGRhdGVzLCBzbGljZVNpemVdKTtcbiAgY29uc3QgdW5pZm9ybURhdGEgPSBbXG4gICAge3R5cGU6ICdpbnQzMicsIGRhdGE6IFtzbGljZVJhbmtdfSxcbiAgICB7dHlwZTogJ2ludDMyJywgZGF0YTogc3RyaWRlc30sXG4gICAge3R5cGU6ICdpbnQzMicsIGRhdGE6IFtzaXplXX0sXG4gIF07XG5cbiAgc3dpdGNoIChudW1VcGRhdGVzKSB7XG4gICAgY2FzZSAwOlxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAxOlxuICAgICAgaWYgKHRydWUpIHtcbiAgICAgICAgY29uc3QgcHJvZ3JhbSA9IG5ldyBTY2F0dGVyUHJvZ3JhbShcbiAgICAgICAgICAgIFtudW1VcGRhdGVzLCBzbGljZVNpemVdLCBzbGljZVJhbmssICRzcGFyc2VJbmRpY2VzLnNoYXBlLmxlbmd0aCxcbiAgICAgICAgICAgICRzcGFyc2VWYWx1ZXMuc2hhcGUubGVuZ3RoLCBzdHJpZGVzLCBmbGF0dGVuU2hhcGUsIHR5cGUsXG4gICAgICAgICAgICBzdW1EdXBlSW5kaWNlcyk7XG4gICAgICAgIGJhY2tlbmQucnVuV2ViR1BVUHJvZ3JhbShcbiAgICAgICAgICAgIHByb2dyYW0sIFskc3BhcnNlVmFsdWVzLCAkc3BhcnNlSW5kaWNlc10sIHR5cGUsIHVuaWZvcm1EYXRhLFxuICAgICAgICAgICAgJGRlbnNlVmFsdWVzKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGRlZmF1bHQ6XG4gICAgICBpZiAodHJ1ZSkge1xuICAgICAgICAvLyBGaXJzdCByZXBsYWNlIHRoZSBkZWZhdWx0IHZhbHVlIHdpdGggMCBhdCBpbmRpY2VzLlxuICAgICAgICBjb25zdCBwcm9ncmFtID0gbmV3IFNjYXR0ZXJQcm9ncmFtKFxuICAgICAgICAgICAgW251bVVwZGF0ZXMsIHNsaWNlU2l6ZV0sIHNsaWNlUmFuaywgJHNwYXJzZUluZGljZXMuc2hhcGUubGVuZ3RoLFxuICAgICAgICAgICAgemVyby5zaGFwZS5sZW5ndGgsIHN0cmlkZXMsIGZsYXR0ZW5TaGFwZSwgdHlwZSwgc3VtRHVwZUluZGljZXMpO1xuICAgICAgICBiYWNrZW5kLnJ1bldlYkdQVVByb2dyYW0oXG4gICAgICAgICAgICBwcm9ncmFtLCBbemVybywgJHNwYXJzZUluZGljZXNdLCB0eXBlLCB1bmlmb3JtRGF0YSwgJGRlbnNlVmFsdWVzKTtcbiAgICAgIH1cbiAgICAgIHtcbiAgICAgICAgLy8gVGhlbiByZXBsYWNlIDAgd2l0aCB0aGUgKHN1bSBvZikgc3BhcnNlIHZhbHVlKHMpIGF0IGluZGljZXMuXG4gICAgICAgIGNvbnN0IHByb2dyYW0gPSBuZXcgU2NhdHRlclByb2dyYW0oXG4gICAgICAgICAgICBbbnVtVXBkYXRlcywgc2xpY2VTaXplXSwgc2xpY2VSYW5rLCAkc3BhcnNlSW5kaWNlcy5zaGFwZS5sZW5ndGgsXG4gICAgICAgICAgICAkc3BhcnNlVmFsdWVzLnNoYXBlLmxlbmd0aCwgc3RyaWRlcywgZmxhdHRlblNoYXBlLCB0eXBlKTtcbiAgICAgICAgYmFja2VuZC5ydW5XZWJHUFVQcm9ncmFtKFxuICAgICAgICAgICAgcHJvZ3JhbSwgWyRzcGFyc2VWYWx1ZXMsICRzcGFyc2VJbmRpY2VzXSwgdHlwZSwgdW5pZm9ybURhdGEsXG4gICAgICAgICAgICAkZGVuc2VWYWx1ZXMpO1xuICAgICAgfVxuICB9XG5cbiAgY29uc3QgZGVuc2VWYWx1ZXMgPSByZXNoYXBlKFxuICAgICAge2lucHV0czoge3g6ICRkZW5zZVZhbHVlc30sIGJhY2tlbmQsIGF0dHJzOiB7c2hhcGU6IG91dHB1dFNoYXBlfX0pO1xuXG4gIGJhY2tlbmQuZGlzcG9zZURhdGEoJHNwYXJzZUluZGljZXMuZGF0YUlkKTtcbiAgYmFja2VuZC5kaXNwb3NlRGF0YSgkc3BhcnNlVmFsdWVzLmRhdGFJZCk7XG4gIGJhY2tlbmQuZGlzcG9zZURhdGEoJGRlZmF1bHRWYWx1ZS5kYXRhSWQpO1xuICBiYWNrZW5kLmRpc3Bvc2VEYXRhKHplcm8uZGF0YUlkKTtcbiAgYmFja2VuZC5kaXNwb3NlRGF0YSgkZGVuc2VWYWx1ZXMuZGF0YUlkKTtcbiAgcmV0dXJuIGRlbnNlVmFsdWVzO1xufVxuXG5leHBvcnQgY29uc3Qgc3BhcnNlVG9EZW5zZUNvbmZpZzogS2VybmVsQ29uZmlnID0ge1xuICBrZXJuZWxOYW1lOiBTcGFyc2VUb0RlbnNlLFxuICBiYWNrZW5kTmFtZTogJ3dlYmdwdScsXG4gIGtlcm5lbEZ1bmM6IHNwYXJzZVRvRGVuc2UgYXMgdW5rbm93biBhcyBLZXJuZWxGdW5jXG59O1xuIl19
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
import './flags_webgpu';
import { backend_util, buffer, DataStorage, engine, env, KernelBackend, util } from '@tensorflow/tfjs-core';
import { AdapterInfo } from './adapter_info';
import { BufferManager } from './buffer_manager';
import { TextureManager } from './texture_manager';
import * as webgpu_program from './webgpu_program';
import * as webgpu_util from './webgpu_util';
// Empirically determined constant used to determine size threshold for handing
// off execution to the CPU.
const CPU_HANDOFF_SIZE_THRESHOLD = env().getNumber('WEBGPU_CPU_HANDOFF_SIZE_THRESHOLD');
// Reshape dispatch, not to exceed device limits.
const reshapeDispatch = (device, program) => {
    const MAX_COMPUTE_PER_DIMENSION_DISPATCH_SIZE = device.limits.maxComputeWorkgroupsPerDimension;
    const layout = program['dispatchLayout'];
    const dispatch = program['dispatch'];
    if (dispatch.every((d) => d <= MAX_COMPUTE_PER_DIMENSION_DISPATCH_SIZE)) {
        return dispatch;
    }
    util.assert(dispatch[0] > MAX_COMPUTE_PER_DIMENSION_DISPATCH_SIZE &&
        layout.y === undefined && layout.z === undefined, () => 'Dispatch size exceeds WebGPU limits in Y or Z dimension.');
    let dispatchAverage = Math.ceil(Math.sqrt(dispatch[0]));
    if (dispatchAverage > MAX_COMPUTE_PER_DIMENSION_DISPATCH_SIZE) {
        dispatchAverage = Math.ceil(Math.cbrt(dispatch[0]));
        util.assert(dispatchAverage <= MAX_COMPUTE_PER_DIMENSION_DISPATCH_SIZE, () => 'Total dispatch size exceeds WebGPU maximum.');
        return [dispatchAverage, dispatchAverage, dispatchAverage];
    }
    else {
        return [dispatchAverage, dispatchAverage, 1];
    }
};
class WebGPUBackend extends KernelBackend {
    nextDataId() {
        return WebGPUBackend.nextDataId++;
    }
    constructor(device, adapterInfo) {
        super();
        this.commandQueueOwnedIds = new WeakSet();
        this.dispatchCountInPass = 0;
        this.disposed = false;
        this.downloadWaitMs = 0;
        this.tensorDataPendingDisposal = [];
        this.queryResolveBuffer = null;
        this.querySet = null;
        this.querySetCount = 2;
        this.stagingPendingDisposal = [];
        this.uniformPendingDisposal = [];
        this.uploadWaitMs = 0;
        this.hasReadSyncWarned = false;
        this.hasTimestampQueryWarned = false;
        if (!webgpu_util.isWebGPUSupported()) {
            throw new Error('WebGPU is not supported on this device');
        }
        this.pipelineCache = {};
        this.device = device;
        this.queue = device.queue;
        this.commandEncoder = null;
        this.computePassEncoder = null;
        this.adapterInfo = new AdapterInfo(adapterInfo);
        this.supportTimestampQuery = this.device.features.has('timestamp-query');
        this.thresholdToIncreaseWorkgroups =
            this.adapterInfo.intelGPUGeneration >= 12 ? 16 : 8;
        this.bufferManager = new BufferManager(this.device);
        this.textureManager = new TextureManager(this.device);
        this.tensorMap = new DataStorage(this, engine());
        // Profiling tools like PIX needs this dummy canvas to
        // trigger capturing a frame.
        if (env().getBool('WEBGPU_USE_PROFILE_TOOL')) {
            this.dummyCanvas = document.createElement('canvas');
            this.dummyCanvas.width = 1;
            this.dummyCanvas.height = 1;
            this.dummyContext = this.dummyCanvas.getContext('webgpu');
            this.dummyContext.configure({
                device,
                format: 'bgra8unorm',
            });
            document.body.appendChild(this.dummyCanvas);
        }
    }
    floatPrecision() {
        return 32;
    }
    /**
     * Dispose the memory if the dataId has 0 refCount. Return true if the memory
     * is released or delayed in this backend, false if there are still
     * references.
     * @param dataId
     * @oaram force Optional, remove the data regardless of refCount
     */
    disposeData(dataId, force = false) {
        // No-op if already disposed.
        if (!this.tensorMap.has(dataId)) {
            return true;
        }
        const tensorData = this.tensorMap.get(dataId);
        if (force) {
            tensorData.refCount = 0;
        }
        else {
            tensorData.refCount--;
        }
        if (tensorData.refCount > 0) {
            return false;
        }
        if (tensorData.complexTensorInfos != null) {
            this.disposeData(tensorData.complexTensorInfos.real.dataId);
            this.disposeData(tensorData.complexTensorInfos.imag.dataId);
        }
        if (this.commandQueueOwnedIds.has(dataId)) {
            this.tensorDataPendingDisposal.push(dataId);
            return true;
        }
        this.releaseResource(dataId);
        this.tensorMap.delete(dataId);
        return true;
    }
    memory() {
        return {
            numBytesInGPU: this.bufferManager.numBytesUsed,
            numBytesAllocatedInGPU: this.bufferManager.numBytesAllocated,
            unreliable: false
        };
    }
    releaseResource(dataId) {
        const tensorData = this.tensorMap.get(dataId);
        if (!tensorData || !tensorData.resource) {
            return;
        }
        // If tensor's resource is from external, do not release.
        if (tensorData.external) {
            tensorData.resource = null;
            return;
        }
        if (tensorData.resource instanceof GPUBuffer) {
            this.bufferManager.releaseBuffer(tensorData.resource);
        }
        else if (tensorData.resource instanceof GPUTexture) {
            this.textureManager.releaseTexture(tensorData.resource);
        }
        tensorData.resource = null;
    }
    /** Return refCount of a `TensorData`. */
    refCount(dataId) {
        if (this.tensorMap.has(dataId)) {
            const tensorData = this.tensorMap.get(dataId);
            return tensorData.refCount;
        }
        return 0;
    }
    /** Increase refCount of a `TensorData`. */
    incRef(dataId) {
        const tensorData = this.tensorMap.get(dataId);
        tensorData.refCount++;
    }
    /** Decrease refCount of a `TensorData`. */
    decRef(dataId) {
        if (this.tensorMap.has(dataId)) {
            const tensorData = this.tensorMap.get(dataId);
            tensorData.refCount--;
        }
    }
    write(values, shape, dtype) {
        if (dtype === 'complex64' && values != null) {
            throw new Error(`Cannot write to a complex64 dtype. ` +
                `Please use tf.complex(real, imag).`);
        }
        const dataId = { id: this.nextDataId() };
        this.tensorMap.set(dataId, { dtype, shape, values, refCount: 1 });
        return dataId;
    }
    move(dataId, values, shape, dtype, refCount) {
        if (dtype === 'complex64') {
            throw new Error(`Cannot write to a complex64 dtype. ` +
                `Please use tf.complex(real, imag).`);
        }
        this.tensorMap.set(dataId, { dtype, shape, values, refCount });
    }
    submitQueue() {
        this.queue.submit([this.commandEncoder.finish()]);
        this.commandEncoder = null;
        this.dispatchCountInPass = 0;
        this.commandQueueOwnedIds = new WeakSet();
        this.tensorDataPendingDisposal.forEach(d => {
            this.releaseResource(d);
            this.tensorMap.delete(d);
        });
        this.uniformPendingDisposal.forEach(b => this.bufferManager.releaseBuffer(b));
        this.stagingPendingDisposal.forEach(b => this.bufferManager.releaseBuffer(b, false));
        this.tensorDataPendingDisposal = [];
        this.uniformPendingDisposal = [];
        this.stagingPendingDisposal = [];
    }
    ensureCommandEncoderReady() {
        if (!this.commandEncoder) {
            this.commandEncoder = this.device.createCommandEncoder();
        }
    }
    endComputePassEncoder() {
        if (this.computePassEncoder) {
            this.computePassEncoder.end();
            this.computePassEncoder = null;
        }
    }
    // Check if parallel compilation is done.
    async checkCompileCompletionAsync() {
        let pipelines;
        try {
            pipelines = await Promise.all(Object.values(this.pipelineCache));
        }
        catch (e) {
            // TODO: Add test case to catch this exception.
            throw new Error(e.message);
        }
        Object.keys(this.pipelineCache).map((key, i) => {
            this.pipelineCache[key] = pipelines[i];
        });
    }
    async getBufferData(buffer) {
        if (env().getBool('WEBGPU_ENGINE_COMPILE_ONLY')) {
            console.warn('The data may be invalid since WEBGPU_ENGINE_COMPILE_ONLY is true, this can only be called when WEBGPU_ENGINE_COMPILE_ONLY is false');
            return null;
        }
        const size = buffer.size;
        const stagingBuffer = this.bufferManager.acquireBuffer(size, GPUBufferUsage.COPY_DST | GPUBufferUsage.MAP_READ);
        this.ensureCommandEncoderReady();
        this.endComputePassEncoder();
        this.commandEncoder.copyBufferToBuffer(buffer, 0, stagingBuffer, 0, size);
        this.submitQueue();
        await stagingBuffer.mapAsync(GPUMapMode.READ);
        const values = stagingBuffer.getMappedRange().slice(0);
        stagingBuffer.unmap();
        if (stagingBuffer != null) {
            this.bufferManager.releaseBuffer(stagingBuffer);
        }
        // Need to get texture from swapChain to enable profiling tool
        // to capture a frame
        if (env().getBool('WEBGPU_USE_PROFILE_TOOL')) {
            util.assert(this.dummyContext !== undefined, () => `Fail to get context for profiling tool`);
            this.dummyContext.getCurrentTexture();
        }
        return values;
    }
    convertAndCacheOnCPU(dataId, data) {
        const tensorData = this.tensorMap.get(dataId);
        tensorData.values = data;
        return tensorData.values;
    }
    readSync(dataId) {
        const tensorData = this.tensorMap.get(dataId);
        const { values, complexTensorInfos } = tensorData;
        if (values != null || tensorData.dtype === 'string') {
            return values;
        }
        if (tensorData.dtype === 'complex64') {
            const realValues = this.readSync(complexTensorInfos.real.dataId);
            const imagValues = this.readSync(complexTensorInfos.imag.dataId);
            const complexVals = util.convertBackendValuesAndArrayBuffer(backend_util.mergeRealAndImagArrays(realValues, imagValues).buffer, 'float32');
            this.convertAndCacheOnCPU(dataId, complexVals);
            return complexVals;
        }
        if (!this.hasReadSyncWarned) {
            this.hasReadSyncWarned = true;
            console.warn(`The performance of synchronously reading data from GPU to CPU is ` +
                `poor on the webgpu backend, please use asynchronous APIs instead.`);
        }
        const alphaModes = ['opaque', 'premultiplied'];
        const buffer = tensorData.resource;
        const bufferSize = buffer.size;
        util.assert(bufferSize % 4 === 0, () => 'Because there is 4 bytes for ' +
            'one pixel, buffer size must be multiple of 4.');
        const pixelsSize = bufferSize / 4;
        const valsGPU = new ArrayBuffer(bufferSize);
        // TODO: adjust the reading window size according the `bufferSize`.
        const canvasWidth = 256, canvasHeight = 256;
        const stagingDeviceStorage = alphaModes.map(_ => new OffscreenCanvas(canvasWidth, canvasHeight));
        const stagingHostStorage = new OffscreenCanvas(canvasWidth, canvasHeight);
        this.endComputePassEncoder();
        stagingDeviceStorage
            .map((storage, index) => {
            const context = storage.getContext('webgpu');
            // TODO: use rgba8unorm format when this format is supported on Mac.
            // https://bugs.chromium.org/p/chromium/issues/detail?id=1298618
            context.configure({
                device: this.device,
                format: 'bgra8unorm',
                usage: GPUTextureUsage.COPY_DST,
                alphaMode: alphaModes[index],
            });
            return context.getCurrentTexture();
        })
            .map((texture, index) => {
            const bytesPerRow = canvasWidth * 4;
            const readDataGPUToCPU = (width, height, offset) => {
                this.ensureCommandEncoderReady();
                this.commandEncoder.copyBufferToTexture({
                    buffer,
                    bytesPerRow,
                    offset,
                }, {
                    texture,
                }, {
                    width,
                    height,
                });
                this.submitQueue();
                const context = stagingHostStorage.getContext('2d', {
                    willReadFrequently: true,
                });
                context.clearRect(0, 0, width, height);
                context.drawImage(stagingDeviceStorage[index], 0, 0);
                const stagingValues = context.getImageData(0, 0, width, height).data;
                const alphaMode = alphaModes[index];
                const span = new Uint8ClampedArray(valsGPU, offset, width * height * 4);
                for (let k = 0; k < span.length; k += 4) {
                    if (alphaMode === 'premultiplied') {
                        span[k + 3] = stagingValues[k + 3];
                    }
                    else {
                        const value = stagingValues[k];
                        span[k] = stagingValues[k + 2];
                        span[k + 1] = stagingValues[k + 1];
                        span[k + 2] = value;
                    }
                }
            };
            const fullyReadCount = Math.floor(pixelsSize / (canvasWidth * canvasHeight));
            let width = canvasWidth, height = canvasHeight, offset = 0;
            for (let i = 0; i < fullyReadCount; i++) {
                // Read the buffer data, which fully fill the whole canvas.
                readDataGPUToCPU(width, height, offset);
                offset += canvasWidth * canvasHeight * 4;
            }
            const remainSize = pixelsSize % (canvasWidth * canvasHeight);
            height = Math.floor(remainSize / canvasWidth);
            if (height > 0) {
                // Read the buffer data, which fully fill certain rows of canvas.
                readDataGPUToCPU(width, height, offset);
                offset += height * (canvasWidth * 4);
            }
            width = remainSize % canvasWidth;
            if (width > 0) {
                // Read the buffer data, which not fully fill one row of canvas.
                readDataGPUToCPU(width, 1, offset);
            }
        });
        const vals = util.convertBackendValuesAndArrayBuffer(valsGPU, tensorData.dtype);
        this.convertAndCacheOnCPU(dataId, vals);
        return vals;
    }
    async read(dataId) {
        if (!this.tensorMap.has(dataId)) {
            throw new Error(`Tensor ${dataId} was not registered!`);
        }
        const tensorData = this.tensorMap.get(dataId);
        const { values } = tensorData;
        if (values != null) {
            return values;
        }
        // Download the values from the GPU.
        let vals;
        if (tensorData.dtype === 'complex64') {
            const ps = await Promise.all([
                this.read(tensorData.complexTensorInfos.real.dataId),
                this.read(tensorData.complexTensorInfos.imag.dataId)
            ]);
            const realValues = ps[0];
            const imagValues = ps[1];
            vals = backend_util.mergeRealAndImagArrays(realValues, imagValues);
        }
        else {
            const data = await this.getBufferData(tensorData.resource);
            vals = util.convertBackendValuesAndArrayBuffer(data, tensorData.dtype);
        }
        this.convertAndCacheOnCPU(dataId, vals);
        return vals;
    }
    // The source GPUBuffer and destination GPUBuffer have the same size and
    // usage.
    copyBuffer(srcBuffer) {
        const size = srcBuffer.size;
        const usage = srcBuffer.usage;
        const dstBuffer = this.bufferManager.acquireBuffer(size, usage);
        this.ensureCommandEncoderReady();
        this.endComputePassEncoder();
        this.commandEncoder.copyBufferToBuffer(srcBuffer, 0, dstBuffer, 0, size);
        this.submitQueue();
        return dstBuffer;
    }
    /**
     * Create a TF.js tensor out of an existing WebGPU buffer.
     */
    createTensorFromGPUData(webGPUData, shape, dtype) {
        let buffer = webGPUData.buffer;
        if (dtype === 'complex64') {
            throw new Error(`Cannot write to a complex64 dtype. `);
        }
        const dataId = { id: this.nextDataId() };
        this.tensorMap.set(dataId, {
            dtype,
            shape,
            values: null,
            refCount: 1,
            external: webGPUData.zeroCopy
        });
        const tensorData = this.tensorMap.get(dataId);
        const size = webgpu_util.GPUBytesPerElement(tensorData.dtype) *
            util.sizeFromShape(tensorData.shape);
        if (webGPUData.buffer.size < size) {
            throw new Error(`GPUBuffer size(${webGPUData.buffer.size}) is smaller than tensor size(${size})!`);
        }
        else if ((webGPUData.buffer.usage &
            (GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC)) !==
            (GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC)) {
            throw new Error('GPUBuffer.usage should include GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC!');
        }
        // Do buffer copy by default.
        if (webGPUData.zeroCopy !== true) {
            buffer = this.copyBuffer(buffer);
        }
        tensorData.resource = buffer;
        return engine().makeTensorFromDataId(dataId, shape, dtype, this);
    }
    /**
     * Read tensor to a new GPUBuffer.
     * @param dataId The source tensor.
     */
    readToGPU(dataId) {
        const srcTensorData = this.tensorMap.get(dataId);
        const { values, dtype, shape, resource } = srcTensorData;
        if (dtype === 'complex64') {
            throw new Error('Does not support reading buffer for complex64 dtype.');
        }
        if (resource == null) {
            if (values != null) {
                throw new Error('Data is not on GPU but on CPU.');
            }
            else {
                throw new Error('There is no data on GPU or CPU.');
            }
        }
        const srcBuffer = resource;
        const size = srcBuffer.size;
        const usage = srcBuffer.usage;
        const buffer = this.bufferManager.acquireBuffer(size, usage);
        this.ensureCommandEncoderReady();
        this.endComputePassEncoder();
        this.commandEncoder.copyBufferToBuffer(resource, 0, buffer, 0, size);
        this.submitQueue();
        const tensorInfo = this.makeTensorInfo(shape, dtype);
        // Make engine track this tensor, so that we can dispose it later.
        const tensorRef = engine().makeTensorFromTensorInfo(tensorInfo);
        const tensorData = this.tensorMap.get(tensorInfo.dataId);
        tensorData.resource = buffer;
        return { tensorRef, buffer };
    }
    bufferSync(t) {
        const data = this.readSync(t.dataId);
        if (t.dtype === 'string') {
            try {
                // Decode the bytes into string.
                const strings = data.map(d => util.decodeString(d));
                return buffer(t.shape, t.dtype, strings);
            }
            catch (_a) {
                throw new Error('Failed to decode encoded string bytes into utf-8');
            }
        }
        return buffer(t.shape, t.dtype, data);
    }
    async time(f) {
        if (!this.supportTimestampQuery && !this.hasTimestampQueryWarned) {
            console.warn(`This device doesn't support timestamp-query extension. ` +
                `Start Chrome browser with flag ` +
                `--disable-dawn-features=disallow_unsafe_apis to try it again. ` +
                `Otherwise, zero will be shown for the kernel time when profiling ` +
                `mode is enabled.`);
            this.hasTimestampQueryWarned = true;
        }
        const oldActiveTimers = this.activeTimers;
        const newActiveTimers = [];
        let outerMostTime = false;
        if (this.programTimersStack == null) {
            this.programTimersStack = newActiveTimers;
            outerMostTime = true;
        }
        else {
            this.activeTimers.push(newActiveTimers);
        }
        this.activeTimers = newActiveTimers;
        f();
        const flattenedActiveTimerQueries = util.flatten(this.activeTimers.map((d) => d.query))
            .filter(d => d != null);
        const flattenedActiveTimerNames = util.flatten(this.activeTimers.map((d) => d.name))
            .filter(d => d != null);
        this.activeTimers = oldActiveTimers;
        if (outerMostTime) {
            this.programTimersStack = null;
        }
        const res = {
            uploadWaitMs: this.uploadWaitMs,
            downloadWaitMs: this.downloadWaitMs,
            kernelMs: null,
            wallMs: null
        };
        const kernelMs = await Promise.all(flattenedActiveTimerQueries);
        res['kernelMs'] = util.sum(kernelMs);
        res['getExtraProfileInfo'] = () => kernelMs.map((d, i) => ({ name: flattenedActiveTimerNames[i], ms: d }))
            .map(d => `${d.name}: ${d.ms}`)
            .join(', ');
        this.uploadWaitMs = 0;
        this.downloadWaitMs = 0;
        return res;
    }
    makeTensorInfo(shape, dtype, values) {
        if (dtype === 'string' && values != null && values.length > 0 &&
            util.isString(values[0])) {
            values = values.map(d => util.encodeString(d));
        }
        const dataId = this.write(values, shape, dtype);
        return { dataId, shape, dtype };
    }
    tensorToBinding(tensor) {
        if (!tensor) {
            return null;
        }
        const tensorData = this.tensorMap.get(tensor.dataId);
        const resource = tensorData.resource;
        if (resource instanceof GPUBuffer) {
            return { buffer: resource };
        }
        if (resource instanceof GPUTexture) {
            return resource.createView();
        }
        // GPUExternalTexture
        return resource;
    }
    uploadToGPU(dataId) {
        const tensorData = this.tensorMap.get(dataId);
        // Already on the GPU.
        if (tensorData.resource != null) {
            return;
        }
        const size = webgpu_util.GPUBytesPerElement(tensorData.dtype) *
            util.sizeFromShape(tensorData.shape);
        let buffer;
        const usage = GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC |
            GPUBufferUsage.COPY_DST;
        if (tensorData.values) {
            buffer = this.bufferManager.acquireBuffer(size, usage, true);
            if (buffer.mapState === 'unmapped') {
                const stagingBuffer = this.bufferManager.acquireBuffer(size, GPUBufferUsage.MAP_WRITE | GPUBufferUsage.COPY_SRC, true, false);
                const arrayBuffer = stagingBuffer.getMappedRange();
                if (tensorData.dtype === 'int32' || tensorData.dtype === 'bool') {
                    new Int32Array(arrayBuffer).set(tensorData.values);
                }
                else {
                    new Float32Array(arrayBuffer).set(tensorData.values);
                }
                stagingBuffer.unmap();
                this.ensureCommandEncoderReady();
                this.endComputePassEncoder();
                this.commandEncoder.copyBufferToBuffer(stagingBuffer, 0, buffer, 0, size);
                this.stagingPendingDisposal.push(stagingBuffer);
            }
            else {
                const arrayBuffer = buffer.getMappedRange();
                if (tensorData.dtype === 'int32' || tensorData.dtype === 'bool') {
                    new Int32Array(arrayBuffer).set(tensorData.values);
                }
                else {
                    new Float32Array(arrayBuffer).set(tensorData.values);
                }
                buffer.unmap();
            }
            // Once uploaded, don't store the values on cpu.
            tensorData.values = null;
        }
        else {
            buffer = this.bufferManager.acquireBuffer(size, usage);
        }
        tensorData.resource = buffer;
    }
    makeUniforms(programUniform) {
        let currentOffset = 0;
        let preLength = 0;
        const offsets = [];
        let maxAlignmentOfField = 1;
        programUniform.forEach((d) => {
            if (d.data.length === 0) {
                d.data = [1];
            }
            // https://www.w3.org/TR/WGSL/#alignof
            let baseAlignment;
            switch (d.data.length) {
                case 1:
                    baseAlignment = 4;
                    break;
                case 2:
                    baseAlignment = 8;
                    break;
                case 3:
                    baseAlignment = 16;
                    break;
                case 4:
                    baseAlignment = 16;
                    break;
                case 5:
                    baseAlignment = 16;
                    break;
                case 6:
                    baseAlignment = 16;
                    break;
                default:
                    util.assert(false, () => `Unsupported ${d.data.length}D shape`);
            }
            if (preLength === 5 || preLength === 6) {
                baseAlignment = 16;
            }
            if (baseAlignment > maxAlignmentOfField) {
                maxAlignmentOfField = baseAlignment;
            }
            currentOffset = Math.ceil(currentOffset / baseAlignment) * baseAlignment;
            preLength = d.data.length;
            offsets.push(currentOffset);
            currentOffset += d.data.length * 4;
        });
        currentOffset =
            Math.ceil(currentOffset / maxAlignmentOfField) * maxAlignmentOfField;
        const arrayBuffer = new ArrayBuffer(currentOffset);
        programUniform.forEach((d, i) => {
            const offset = offsets[i];
            if (d.type === 'int32') {
                new Int32Array(arrayBuffer, offset, d.data.length).set(d.data);
            }
            else if (d.type === 'uint32') {
                new Uint32Array(arrayBuffer, offset, d.data.length).set(d.data);
            }
            else {
                new Float32Array(arrayBuffer, offset, d.data.length).set(d.data);
            }
        });
        const uniformBuffer = this.bufferManager.acquireBuffer(currentOffset, GPUBufferUsage.COPY_DST | GPUBufferUsage.UNIFORM);
        this.queue.writeBuffer(uniformBuffer, 0, arrayBuffer, 0, currentOffset);
        this.uniformPendingDisposal.push(uniformBuffer);
        return { offset: 0, size: currentOffset, buffer: uniformBuffer };
    }
    runWebGPUProgram(program, inputs, outputDtype, programDefinedUniform, output) {
        if (!output) {
            output = this.makeTensorInfo(program.outputShape, outputDtype);
        }
        if (util.sizeFromShape(output.shape) === 0) {
            // Short-circuit the computation since the result is empty (has 0 in its
            // shape).
            this.tensorMap.get(output.dataId).values =
                util.getTypedArrayFromDType(output.dtype, 0);
            return output;
        }
        this.uploadToGPU(output.dataId);
        program.dispatch = reshapeDispatch(this.device, program);
        const inputsData = inputs.map((input, i) => {
            if (input.dtype === 'complex64') {
                throw new Error(`GPGPUProgram does not support complex64 input. For complex64 ` +
                    `dtypes, please separate the program into real and imaginary ` +
                    `parts.`);
            }
            this.uploadToGPU(input.dataId);
            return {
                // Returning dtype from tensorMap because it reflects dtype
                // of underlying buffer, rather than abstract dtype.
                dtype: this.tensorMap.get(input.dataId).dtype,
                shape: input.shape,
                name: program.variableNames[i]
            };
        });
        program.shaderKey =
            webgpu_program.makeShaderKey(program, inputsData, output);
        const parallelCompilation = env().getBool('WEBGPU_ENGINE_COMPILE_ONLY');
        if (!(program.shaderKey in this.pipelineCache)) {
            this.pipelineCache[program.shaderKey] = webgpu_program.compileProgram(this.device, program, inputsData, output, parallelCompilation);
        }
        program.pipeline = this.pipelineCache[program.shaderKey];
        if (!parallelCompilation) {
            this.recordAndSubmit(program, output, inputs, programDefinedUniform);
        }
        return output;
    }
    recordAndSubmit(program, output, inputs, programDefinedUniform) {
        if (program.pipeline instanceof Promise) {
            throw new Error('Please call checkCompileCompletionAsync to ensure parallel compilation is done!');
        }
        // There are six kinds of uniforms: NAN, INFINITY, shapes, shape strides,
        // program size, program defined uniforms.
        let programUniform = [];
        let bufferShapes = [];
        const uniformsType = 'int32';
        if (program.pixelsOpType == null) {
            programUniform.push({ type: 'float32', data: [NaN] }, { type: 'float32', data: [Infinity] });
            bufferShapes = inputs.concat(output).map(d => d.shape);
            const uniformsType = 'int32';
            bufferShapes.map(d => {
                programUniform.push({ type: uniformsType, data: d });
                const strides = util.computeStrides(d);
                programUniform.push({ type: uniformsType, data: strides });
            });
        }
        else {
            const strides = util.computeStrides(output.shape);
            programUniform.push({ type: uniformsType, data: strides });
        }
        if (program.size) {
            const size = util.sizeFromShape(program.outputShape);
            programUniform.push({
                type: uniformsType,
                data: [program.outputComponent ? size / program.outputComponent : size]
            });
        }
        if (programDefinedUniform) {
            programUniform = [...programUniform, ...programDefinedUniform];
        }
        const bindings = [
            this.tensorToBinding(output), ...inputs.map(t => this.tensorToBinding(t)),
            this.makeUniforms(programUniform)
        ];
        inputs.forEach(input => {
            this.commandQueueOwnedIds.add(input.dataId);
        });
        this.commandQueueOwnedIds.add(output.dataId);
        const bindGroup = this.device.createBindGroup({
            layout: program.pipeline.getBindGroupLayout(0),
            entries: bindings.map((b, i) => ({ binding: i, resource: b })),
        });
        const shouldTimeProgram = this.activeTimers != null;
        this.ensureCommandEncoderReady();
        const computePassDescriptor = {};
        if (shouldTimeProgram && this.supportTimestampQuery) {
            this.endComputePassEncoder();
            if (this.querySet == null) {
                this.querySet = this.device.createQuerySet({
                    type: 'timestamp',
                    count: this.querySetCount,
                });
            }
            computePassDescriptor.timestampWrites = [
                {
                    querySet: this.querySet,
                    queryIndex: 0,
                    location: 'beginning',
                },
                {
                    querySet: this.querySet,
                    queryIndex: 1,
                    location: 'end',
                }
            ];
            this.computePassEncoder =
                this.commandEncoder.beginComputePass(computePassDescriptor);
        }
        else if (!this.computePassEncoder) {
            this.computePassEncoder =
                this.commandEncoder.beginComputePass(computePassDescriptor);
        }
        this.computePassEncoder.setPipeline(program.pipeline);
        this.computePassEncoder.setBindGroup(0, bindGroup);
        this.computePassEncoder.dispatchWorkgroups(program.dispatch[0], program.dispatch[1], program.dispatch[2]);
        this.dispatchCountInPass++;
        if (shouldTimeProgram ||
            env().get('WEBGPU_DEFERRED_SUBMIT_BATCH_SIZE') <= this.dispatchCountInPass ||
            program.pixelsOpType === webgpu_program.PixelsOpType.DRAW) {
            this.endComputePassEncoder();
            if (shouldTimeProgram) {
                this.activeTimers.push({ name: program.constructor.name, query: this.getQueryTime() });
            }
            else {
                this.submitQueue();
            }
        }
    }
    async getQueryTime() {
        if (!this.supportTimestampQuery) {
            return 0;
        }
        if (this.queryResolveBuffer == null) {
            this.queryResolveBuffer = this.bufferManager.acquireBuffer(this.querySetCount * 8, GPUBufferUsage.COPY_SRC | GPUBufferUsage.COPY_DST |
                GPUBufferUsage.QUERY_RESOLVE);
        }
        this.commandEncoder.resolveQuerySet(this.querySet, 0, this.querySetCount, this.queryResolveBuffer, 0);
        const queryStagingBuffer = this.bufferManager.acquireBuffer(this.querySetCount * 8, GPUBufferUsage.MAP_READ | GPUBufferUsage.COPY_DST);
        this.commandEncoder.copyBufferToBuffer(this.queryResolveBuffer, 0, queryStagingBuffer, 0, this.querySetCount * 8);
        this.submitQueue();
        await queryStagingBuffer.mapAsync(GPUMapMode.READ);
        const arrayBuffer = new BigUint64Array(queryStagingBuffer.getMappedRange());
        const time = Number(arrayBuffer[1] - arrayBuffer[0]) / 1000000;
        queryStagingBuffer.unmap();
        this.bufferManager.releaseBuffer(queryStagingBuffer);
        return time;
    }
    shouldExecuteOnCPU(inputs, sizeThreshold = CPU_HANDOFF_SIZE_THRESHOLD) {
        return env().getBool('WEBGPU_CPU_FORWARD') &&
            inputs.every(input => this.tensorMap.get(input.dataId).resource == null &&
                util.sizeFromShape(input.shape) < sizeThreshold);
    }
    numDataIds() {
        return this.tensorMap.numDataIds() - this.tensorDataPendingDisposal.length;
    }
    dispose() {
        if (this.disposed) {
            return;
        }
        if (this.querySet != null) {
            this.querySet.destroy();
        }
        this.bufferManager.dispose();
        this.textureManager.dispose();
        this.disposed = true;
    }
}
WebGPUBackend.nextDataId = 0;
export { WebGPUBackend };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2VuZF93ZWJncHUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi90ZmpzLWJhY2tlbmQtd2ViZ3B1L3NyYy9iYWNrZW5kX3dlYmdwdS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7QUFFSCxPQUFPLGdCQUFnQixDQUFDO0FBRXhCLE9BQU8sRUFBQyxZQUFZLEVBQWlCLE1BQU0sRUFBRSxXQUFXLEVBQVksTUFBTSxFQUFFLEdBQUcsRUFBVyxhQUFhLEVBQTRGLElBQUksRUFBYSxNQUFNLHVCQUF1QixDQUFDO0FBRWxQLE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sa0JBQWtCLENBQUM7QUFDL0MsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLG1CQUFtQixDQUFDO0FBQ2pELE9BQU8sS0FBSyxjQUFjLE1BQU0sa0JBQWtCLENBQUM7QUFDbkQsT0FBTyxLQUFLLFdBQVcsTUFBTSxlQUFlLENBQUM7QUF1QzdDLCtFQUErRTtBQUMvRSw0QkFBNEI7QUFDNUIsTUFBTSwwQkFBMEIsR0FDNUIsR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7QUFFekQsaURBQWlEO0FBQ2pELE1BQU0sZUFBZSxHQUNqQixDQUFDLE1BQWlCLEVBQ2pCLE9BQXFDLEVBQTRCLEVBQUU7SUFDbEUsTUFBTSx1Q0FBdUMsR0FDekMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxnQ0FBZ0MsQ0FBQztJQUNuRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUN6QyxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDckMsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksdUNBQXVDLENBQUMsRUFBRTtR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Q0FBQyxRQUFRLElBQUksSUFBSSxFQUFFO1lBQ3pCLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUM7U0FDekI7UUFDRCxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDOUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7SUFDdkIsQ0FBQzs7QUE3NkJjLHdCQUFVLEdBQUcsQ0FBQyxBQUFKLENBQUs7U0FuQm5CLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBHb29nbGUgTExDLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICovXG5cbmltcG9ydCAnLi9mbGFnc193ZWJncHUnO1xuXG5pbXBvcnQge2JhY2tlbmRfdXRpbCwgQmFja2VuZFZhbHVlcywgYnVmZmVyLCBEYXRhU3RvcmFnZSwgRGF0YVR5cGUsIGVuZ2luZSwgZW52LCBHUFVEYXRhLCBLZXJuZWxCYWNrZW5kLCBSYW5rLCBSZWN1cnNpdmVBcnJheSwgU2hhcGVNYXAsIFRlbnNvciwgVGVuc29yQnVmZmVyLCBUZW5zb3JJbmZvLCBUaW1pbmdJbmZvLCBUeXBlZEFycmF5LCB1dGlsLCBXZWJHUFVEYXRhfSBmcm9tICdAdGVuc29yZmxvdy90ZmpzLWNvcmUnO1xuXG5pbXBvcnQge0FkYXB0ZXJJbmZvfSBmcm9tICcuL2FkYXB0ZXJfaW5mbyc7XG5pbXBvcnQge0J1ZmZlck1hbmFnZXJ9IGZyb20gJy4vYnVmZmVyX21hbmFnZXInO1xuaW1wb3J0IHtUZXh0dXJlTWFuYWdlcn0gZnJvbSAnLi90ZXh0dXJlX21hbmFnZXInO1xuaW1wb3J0ICogYXMgd2ViZ3B1X3Byb2dyYW0gZnJvbSAnLi93ZWJncHVfcHJvZ3JhbSc7XG5pbXBvcnQgKiBhcyB3ZWJncHVfdXRpbCBmcm9tICcuL3dlYmdwdV91dGlsJztcblxuZXhwb3J0IGludGVyZmFjZSBXZWJHUFVNZW1vcnlJbmZvIGV4dGVuZHMgYmFja2VuZF91dGlsLk1lbW9yeUluZm8ge1xuICBudW1CeXRlc0luR1BVOiBudW1iZXI7XG4gIG51bUJ5dGVzQWxsb2NhdGVkSW5HUFU6IG51bWJlcjtcbiAgdW5yZWxpYWJsZTogYm9vbGVhbjtcbn1cblxudHlwZSBUZW5zb3JEYXRhID0ge1xuICB2YWx1ZXM6IEJhY2tlbmRWYWx1ZXMsXG4gIGR0eXBlOiBEYXRhVHlwZSxcbiAgc2hhcGU6IG51bWJlcltdLFxuICByZWZDb3VudDogbnVtYmVyLFxuICByZXNvdXJjZT86IEdQVUJ1ZmZlcnxHUFVUZXh0dXJlfEdQVUV4dGVybmFsVGV4dHVyZSxcbiAgLy8gZXh0ZXJuYWwgaXMgdHJ1ZSBtZWFucyB3ZSB1c2UgdGhlIHJlc291cmNlIHByb3ZpZGVkIGJ5IHVzZXJzIGRpcmVjdGx5XG4gIC8vICh3aXRob3V0IGEgY29weSksIHNvIHVzZXJzIHNob3VsZCBiZSByZXNwb25zaWJsZSBmb3IgaXRzIHJlbGVhc2UuXG4gIGV4dGVybmFsPzogYm9vbGVhbixcbiAgLy8gRm9yIGNvbXBsZXggbnVtYmVycywgdGhlIHJlYWwgYW5kIGltYWdpbmFyeSBwYXJ0cyBhcmUgc3RvcmVkIGFzIHRoZWlyIG93blxuICAvLyBpbmRpdmlkdWFsIHRlbnNvcnMsIHdpdGggYSBwYXJlbnQgam9pbmluZyB0aGUgdHdvIHdpdGggdGhlXG4gIC8vIGNvbXBsZXhUZW5zb3JJbmZvcyBmaWVsZC5cbiAgY29tcGxleFRlbnNvckluZm9zPzoge3JlYWw6IFRlbnNvckluZm8sIGltYWc6IFRlbnNvckluZm99XG59O1xuXG5pbnRlcmZhY2UgRGF0YUlkIHt9XG5cbmV4cG9ydCB0eXBlIFdlYkdQVUtlcm5lbEluZm8gPSB7XG4gIG5hbWU6IHN0cmluZyxcbiAgcXVlcnk6IFByb21pc2U8bnVtYmVyPixcbn07XG5cbmV4cG9ydCB0eXBlIFRpbWVyTm9kZSA9IFJlY3Vyc2l2ZUFycmF5PFdlYkdQVUtlcm5lbEluZm8+fFdlYkdQVUtlcm5lbEluZm87XG5cbmV4cG9ydCBpbnRlcmZhY2UgV2ViR1BVVGltaW5nSW5mbyBleHRlbmRzIFRpbWluZ0luZm8ge1xuICB1cGxvYWRXYWl0TXM6IG51bWJlcjtcbiAgZG93bmxvYWRXYWl0TXM6IG51bWJlcjtcbn1cblxudHlwZSBQcm9ncmFtVW5pZm9ybSA9IEFycmF5PHt0eXBlOiBzdHJpbmc7IGRhdGE6IG51bWJlcltdfT47XG5cbi8vIEVtcGlyaWNhbGx5IGRldGVybWluZWQgY29uc3RhbnQgdXNlZCB0byBkZXRlcm1pbmUgc2l6ZSB0aHJlc2hvbGQgZm9yIGhhbmRpbmdcbi8vIG9mZiBleGVjdXRpb24gdG8gdGhlIENQVS5cbmNvbnN0IENQVV9IQU5ET0ZGX1NJWkVfVEhSRVNIT0xEID1cbiAgICBlbnYoKS5nZXROdW1iZXIoJ1dFQkdQVV9DUFVfSEFORE9GRl9TSVpFX1RIUkVTSE9MRCcpO1xuXG4vLyBSZXNoYXBlIGRpc3BhdGNoLCBub3QgdG8gZXhjZWVkIGRldmljZSBsaW1pdHMuXG5jb25zdCByZXNoYXBlRGlzcGF0Y2ggPVxuICAgIChkZXZpY2U6IEdQVURldmljZSxcbiAgICAgcHJvZ3JhbTogd2ViZ3B1X3Byb2dyYW0uV2ViR1BVUHJvZ3JhbSk6IFtudW1iZXIsIG51bWJlciwgbnVtYmVyXSA9PiB7XG4gICAgICBjb25zdCBNQVhfQ09NUFVURV9QRVJfRElNRU5TSU9OX0RJU1BBVENIX1NJWkUgPVxuICAgICAgICAgIGRldmljZS5saW1pdHMubWF4Q29tcHV0ZVdvcmtncm91cHNQZXJEaW1lbnNpb247XG4gICAgICBjb25zdCBsYXlvdXQgPSBwcm9ncmFtWydkaXNwYXRjaExheW91dCddO1xuICAgICAgY29uc3QgZGlzcGF0Y2ggPSBwcm9ncmFtWydkaXNwYXRjaCddO1xuICAgICAgaWYgKGRpc3BhdGNoLmV2ZXJ5KChkKSA9PiBkIDw9IE1BWF9DT01QVVRFX1BFUl9ESU1FTlNJT05fRElTUEFUQ0hfU0laRSkpIHtcbiAgICAgICAgcmV0dXJuIGRpc3BhdGNoO1xuICAgICAgfVxuXG4gICAgICB1dGlsLmFzc2VydChcbiAgICAgICAgICBkaXNwYXRjaFswXSA+IE1BWF9DT01QVVRFX1BFUl9ESU1FTlNJT05fRElTUEFUQ0hfU0laRSAmJlxuICAgICAgICAgICAgICBsYXlvdXQueSA9PT0gdW5kZWZpbmVkICYmIGxheW91dC56ID09PSB1bmRlZmluZWQsXG4gICAgICAgICAgKCkgPT4gJ0Rpc3BhdGNoIHNpemUgZXhjZWVkcyBXZWJHUFUgbGltaXRzIGluIFkgb3IgWiBkaW1lbnNpb24uJyk7XG5cbiAgICAgIGxldCBkaXNwYXRjaEF2ZXJhZ2UgPSBNYXRoLmNlaWwoTWF0aC5zcXJ0KGRpc3BhdGNoWzBdKSk7XG4gICAgICBpZiAoZGlzcGF0Y2hBdmVyYWdlID4gTUFYX0NPTVBVVEVfUEVSX0RJTUVOU0lPTl9ESVNQQVRDSF9TSVpFKSB7XG4gICAgICAgIGRpc3BhdGNoQXZlcmFnZSA9IE1hdGguY2VpbChNYXRoLmNicnQoZGlzcGF0Y2hbMF0pKTtcbiAgICAgICAgdXRpbC5hc3NlcnQoXG4gICAgICAgICAgICBkaXNwYXRjaEF2ZXJhZ2UgPD0gTUFYX0NPTVBVVEVfUEVSX0RJTUVOU0lPTl9ESVNQQVRDSF9TSVpFLFxuICAgICAgICAgICAgKCkgPT4gJ1RvdGFsIGRpc3BhdGNoIHNpemUgZXhjZWVkcyBXZWJHUFUgbWF4aW11bS4nKTtcbiAgICAgICAgcmV0dXJuIFtkaXNwYXRjaEF2ZXJhZ2UsIGRpc3BhdGNoQXZlcmFnZSwgZGlzcGF0Y2hBdmVyYWdlXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBbZGlzcGF0Y2hBdmVyYWdlLCBkaXNwYXRjaEF2ZXJhZ2UsIDFdO1xuICAgICAgfVxuICAgIH07XG5cbmV4cG9ydCBjbGFzcyBXZWJHUFVCYWNrZW5kIGV4dGVuZHMgS2VybmVsQmFja2VuZCB7XG4gIGJ1ZmZlck1hbmFnZXI6IEJ1ZmZlck1hbmFnZXI7XG4gIGFkYXB0ZXJJbmZvOiBBZGFwdGVySW5mbztcbiAgZGV2aWNlOiBHUFVEZXZpY2U7XG4gIHF1ZXVlOiBHUFVRdWV1ZTtcbiAgdGVuc29yTWFwOiBEYXRhU3RvcmFnZTxUZW5zb3JEYXRhPjtcbiAgdGV4dHVyZU1hbmFnZXI6IFRleHR1cmVNYW5hZ2VyO1xuICB0aHJlc2hvbGRUb0luY3JlYXNlV29ya2dyb3VwczogbnVtYmVyO1xuXG4gIHByaXZhdGUgYWN0aXZlVGltZXJzOiBUaW1lck5vZGVbXTtcbiAgcHJpdmF0ZSBjb21tYW5kRW5jb2RlcjogR1BVQ29tbWFuZEVuY29kZXI7XG4gIHByaXZhdGUgY29tcHV0ZVBhc3NFbmNvZGVyOiBHUFVDb21wdXRlUGFzc0VuY29kZXI7XG4gIHByaXZhdGUgY29tbWFuZFF1ZXVlT3duZWRJZHMgPSBuZXcgV2Vha1NldDxEYXRhSWQ+KCk7XG4gIHByaXZhdGUgZGlzcGF0Y2hDb3VudEluUGFzcyA9IDA7XG4gIHByaXZhdGUgZGlzcG9zZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBkb3dubG9hZFdhaXRNcyA9IDA7XG4gIHByaXZhdGUgZHVtbXlDYW52YXM6IEhUTUxDYW52YXNFbGVtZW50O1xuICBwcml2YXRlIGR1bW15Q29udGV4dDogR1BVQ2FudmFzQ29udGV4dDtcbiAgcHJpdmF0ZSB0ZW5zb3JEYXRhUGVuZGluZ0Rpc3Bvc2FsOiBEYXRhSWRbXSA9IFtdO1xuICBwcml2YXRlIHN0YXRpYyBuZXh0RGF0YUlkID0gMDtcbiAgcHJpdmF0ZSBwaXBlbGluZUNhY2hlOlxuICAgICAge1trZXk6IHN0cmluZ106IEdQVUNvbXB1dGVQaXBlbGluZXxQcm9taXNlPEdQVUNvbXB1dGVQaXBlbGluZT59O1xuICBwcml2YXRlIHByb2dyYW1UaW1lcnNTdGFjazogVGltZXJOb2RlW107XG4gIHByaXZhdGUgcXVlcnlSZXNvbHZlQnVmZmVyOiBHUFVCdWZmZXIgPSBudWxsO1xuICBwcml2YXRlIHF1ZXJ5U2V0OiBHUFVRdWVyeVNldCA9IG51bGw7XG4gIHByaXZhdGUgcXVlcnlTZXRDb3VudCA9IDI7XG4gIHByaXZhdGUgc3RhZ2luZ1BlbmRpbmdEaXNwb3NhbDogR1BVQnVmZmVyW10gPSBbXTtcbiAgcHJpdmF0ZSBzdXBwb3J0VGltZXN0YW1wUXVlcnk6IGJvb2xlYW47XG4gIHByaXZhdGUgdW5pZm9ybVBlbmRpbmdEaXNwb3NhbDogR1BVQnVmZmVyW10gPSBbXTtcbiAgcHJpdmF0ZSB1cGxvYWRXYWl0TXMgPSAwO1xuICBwcml2YXRlIGhhc1JlYWRTeW5jV2FybmVkID0gZmFsc2U7XG4gIHByaXZhdGUgaGFzVGltZXN0YW1wUXVlcnlXYXJuZWQgPSBmYWxzZTtcblxuICBwcml2YXRlIG5leHREYXRhSWQoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gV2ViR1BVQmFja2VuZC5uZXh0RGF0YUlkKys7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihkZXZpY2U6IEdQVURldmljZSwgYWRhcHRlckluZm8/OiBHUFVBZGFwdGVySW5mbykge1xuICAgIHN1cGVyKCk7XG4gICAgaWYgKCF3ZWJncHVfdXRpbC5pc1dlYkdQVVN1cHBvcnRlZCgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1dlYkdQVSBpcyBub3Qgc3VwcG9ydGVkIG9uIHRoaXMgZGV2aWNlJyk7XG4gICAgfVxuICAgIHRoaXMucGlwZWxpbmVDYWNoZSA9IHt9O1xuICAgIHRoaXMuZGV2aWNlID0gZGV2aWNlO1xuICAgIHRoaXMucXVldWUgPSBkZXZpY2UucXVldWU7XG4gICAgdGhpcy5jb21tYW5kRW5jb2RlciA9IG51bGw7XG4gICAgdGhpcy5jb21wdXRlUGFzc0VuY29kZXIgPSBudWxsO1xuICAgIHRoaXMuYWRhcHRlckluZm8gPSBuZXcgQWRhcHRlckluZm8oYWRhcHRlckluZm8pO1xuICAgIHRoaXMuc3VwcG9ydFRpbWVzdGFtcFF1ZXJ5ID0gdGhpcy5kZXZpY2UuZmVhdHVyZXMuaGFzKCd0aW1lc3RhbXAtcXVlcnknKTtcbiAgICB0aGlzLnRocmVzaG9sZFRvSW5jcmVhc2VXb3JrZ3JvdXBzID1cbiAgICAgICAgdGhpcy5hZGFwdGVySW5mby5pbnRlbEdQVUdlbmVyYXRpb24gPj0gMTIgPyAxNiA6IDg7XG5cbiAgICB0aGlzLmJ1ZmZlck1hbmFnZXIgPSBuZXcgQnVmZmVyTWFuYWdlcih0aGlzLmRldmljZSk7XG4gICAgdGhpcy50ZXh0dXJlTWFuYWdlciA9IG5ldyBUZXh0dXJlTWFuYWdlcih0aGlzLmRldmljZSk7XG4gICAgdGhpcy50ZW5zb3JNYXAgPSBuZXcgRGF0YVN0b3JhZ2UodGhpcywgZW5naW5lKCkpO1xuXG4gICAgLy8gUHJvZmlsaW5nIHRvb2xzIGxpa2UgUElYIG5lZWRzIHRoaXMgZHVtbXkgY2FudmFzIHRvXG4gICAgLy8gdHJpZ2dlciBjYXB0dXJpbmcgYSBmcmFtZS5cbiAgICBpZiAoZW52KCkuZ2V0Qm9vbCgnV0VCR1BVX1VTRV9QUk9GSUxFX1RPT0wnKSkge1xuICAgICAgdGhpcy5kdW1teUNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgICAgdGhpcy5kdW1teUNhbnZhcy53aWR0aCA9IDE7XG4gICAgICB0aGlzLmR1bW15Q2FudmFzLmhlaWdodCA9IDE7XG5cbiAgICAgIHRoaXMuZHVtbXlDb250ZXh0ID0gdGhpcy5kdW1teUNhbnZhcy5nZXRDb250ZXh0KCd3ZWJncHUnKTtcbiAgICAgIHRoaXMuZHVtbXlDb250ZXh0LmNvbmZpZ3VyZSh7XG4gICAgICAgIGRldmljZSxcbiAgICAgICAgZm9ybWF0OiAnYmdyYTh1bm9ybScsXG4gICAgICB9KTtcblxuICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmR1bW15Q2FudmFzKTtcbiAgICB9XG4gIH1cblxuICBvdmVycmlkZSBmbG9hdFByZWNpc2lvbigpOiAzMiB7XG4gICAgcmV0dXJuIDMyO1xuICB9XG5cbiAgLyoqXG4gICAqIERpc3Bvc2UgdGhlIG1lbW9yeSBpZiB0aGUgZGF0YUlkIGhhcyAwIHJlZkNvdW50LiBSZXR1cm4gdHJ1ZSBpZiB0aGUgbWVtb3J5XG4gICAqIGlzIHJlbGVhc2VkIG9yIGRlbGF5ZWQgaW4gdGhpcyBiYWNrZW5kLCBmYWxzZSBpZiB0aGVyZSBhcmUgc3RpbGxcbiAgICogcmVmZXJlbmNlcy5cbiAgICogQHBhcmFtIGRhdGFJZFxuICAgKiBAb2FyYW0gZm9yY2UgT3B0aW9uYWwsIHJlbW92ZSB0aGUgZGF0YSByZWdhcmRsZXNzIG9mIHJlZkNvdW50XG4gICAqL1xuICBvdmVycmlkZSBkaXNwb3NlRGF0YShkYXRhSWQ6IERhdGFJZCwgZm9yY2UgPSBmYWxzZSk6IGJvb2xlYW4ge1xuICAgIC8vIE5vLW9wIGlmIGFscmVhZHkgZGlzcG9zZWQuXG4gICAgaWYgKCF0aGlzLnRlbnNvck1hcC5oYXMoZGF0YUlkKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgY29uc3QgdGVuc29yRGF0YSA9IHRoaXMudGVuc29yTWFwLmdldChkYXRhSWQpO1xuICAgIGlmIChmb3JjZSkge1xuICAgICAgdGVuc29yRGF0YS5yZWZDb3VudCA9IDA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRlbnNvckRhdGEucmVmQ291bnQtLTtcbiAgICB9XG5cbiAgICBpZiAodGVuc29yRGF0YS5yZWZDb3VudCA+IDApIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAodGVuc29yRGF0YS5jb21wbGV4VGVuc29ySW5mb3MgIT0gbnVsbCkge1xuICAgICAgdGhpcy5kaXNwb3NlRGF0YSh0ZW5zb3JEYXRhLmNvbXBsZXhUZW5zb3JJbmZvcy5yZWFsLmRhdGFJZCk7XG4gICAgICB0aGlzLmRpc3Bvc2VEYXRhKHRlbnNvckRhdGEuY29tcGxleFRlbnNvckluZm9zLmltYWcuZGF0YUlkKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5jb21tYW5kUXVldWVPd25lZElkcy5oYXMoZGF0YUlkKSkge1xuICAgICAgdGhpcy50ZW5zb3JEYXRhUGVuZGluZ0Rpc3Bvc2FsLnB1c2goZGF0YUlkKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHRoaXMucmVsZWFzZVJlc291cmNlKGRhdGFJZCk7XG4gICAgdGhpcy50ZW5zb3JNYXAuZGVsZXRlKGRhdGFJZCk7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIG92ZXJyaWRlIG1lbW9yeSgpOiBXZWJHUFVNZW1vcnlJbmZvIHtcbiAgICByZXR1cm4ge1xuICAgICAgbnVtQnl0ZXNJbkdQVTogdGhpcy5idWZmZXJNYW5hZ2VyLm51bUJ5dGVzVXNlZCxcbiAgICAgIG51bUJ5dGVzQWxsb2NhdGVkSW5HUFU6IHRoaXMuYnVmZmVyTWFuYWdlci5udW1CeXRlc0FsbG9jYXRlZCxcbiAgICAgIHVucmVsaWFibGU6IGZhbHNlXG4gICAgfSBhcyBXZWJHUFVNZW1vcnlJbmZvO1xuICB9XG5cbiAgcHJpdmF0ZSByZWxlYXNlUmVzb3VyY2UoZGF0YUlkOiBEYXRhSWQpIHtcbiAgICBjb25zdCB0ZW5zb3JEYXRhID0gdGhpcy50ZW5zb3JNYXAuZ2V0KGRhdGFJZCk7XG4gICAgaWYgKCF0ZW5zb3JEYXRhIHx8ICF0ZW5zb3JEYXRhLnJlc291cmNlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gSWYgdGVuc29yJ3MgcmVzb3VyY2UgaXMgZnJvbSBleHRlcm5hbCwgZG8gbm90IHJlbGVhc2UuXG4gICAgaWYgKHRlbnNvckRhdGEuZXh0ZXJuYWwpIHtcbiAgICAgIHRlbnNvckRhdGEucmVzb3VyY2UgPSBudWxsO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGVuc29yRGF0YS5yZXNvdXJjZSBpbnN0YW5jZW9mIEdQVUJ1ZmZlcikge1xuICAgICAgdGhpcy5idWZmZXJNYW5hZ2VyLnJlbGVhc2VCdWZmZXIodGVuc29yRGF0YS5yZXNvdXJjZSk7XG4gICAgfSBlbHNlIGlmICh0ZW5zb3JEYXRhLnJlc291cmNlIGluc3RhbmNlb2YgR1BVVGV4dHVyZSkge1xuICAgICAgdGhpcy50ZXh0dXJlTWFuYWdlci5yZWxlYXNlVGV4dHVyZSh0ZW5zb3JEYXRhLnJlc291cmNlKTtcbiAgICB9XG4gICAgdGVuc29yRGF0YS5yZXNvdXJjZSA9IG51bGw7XG4gIH1cblxuICAvKiogUmV0dXJuIHJlZkNvdW50IG9mIGEgYFRlbnNvckRhdGFgLiAqL1xuICBvdmVycmlkZSByZWZDb3VudChkYXRhSWQ6IERhdGFJZCk6IG51bWJlciB7XG4gICAgaWYgKHRoaXMudGVuc29yTWFwLmhhcyhkYXRhSWQpKSB7XG4gICAgICBjb25zdCB0ZW5zb3JEYXRhID0gdGhpcy50ZW5zb3JNYXAuZ2V0KGRhdGFJZCk7XG4gICAgICByZXR1cm4gdGVuc29yRGF0YS5yZWZDb3VudDtcbiAgICB9XG4gICAgcmV0dXJuIDA7XG4gIH1cblxuICAvKiogSW5jcmVhc2UgcmVmQ291bnQgb2YgYSBgVGVuc29yRGF0YWAuICovXG4gIG92ZXJyaWRlIGluY1JlZihkYXRhSWQ6IERhdGFJZCk6IHZvaWQge1xuICAgIGNvbnN0IHRlbnNvckRhdGEgPSB0aGlzLnRlbnNvck1hcC5nZXQoZGF0YUlkKTtcbiAgICB0ZW5zb3JEYXRhLnJlZkNvdW50Kys7XG4gIH1cblxuICAvKiogRGVjcmVhc2UgcmVmQ291bnQgb2YgYSBgVGVuc29yRGF0YWAuICovXG4gIGRlY1JlZihkYXRhSWQ6IERhdGFJZCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnRlbnNvck1hcC5oYXMoZGF0YUlkKSkge1xuICAgICAgY29uc3QgdGVuc29yRGF0YSA9IHRoaXMudGVuc29yTWFwLmdldChkYXRhSWQpO1xuICAgICAgdGVuc29yRGF0YS5yZWZDb3VudC0tO1xuICAgIH1cbiAgfVxuXG4gIG92ZXJyaWRlIHdyaXRlKHZhbHVlczogQmFja2VuZFZhbHVlcywgc2hhcGU6IG51bWJlcltdLCBkdHlwZTogRGF0YVR5cGUpOlxuICAgICAgRGF0YUlkIHtcbiAgICBpZiAoZHR5cGUgPT09ICdjb21wbGV4NjQnICYmIHZhbHVlcyAhPSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCB3cml0ZSB0byBhIGNvbXBsZXg2NCBkdHlwZS4gYCArXG4gICAgICAgICAgYFBsZWFzZSB1c2UgdGYuY29tcGxleChyZWFsLCBpbWFnKS5gKTtcbiAgICB9XG4gICAgY29uc3QgZGF0YUlkID0ge2lkOiB0aGlzLm5leHREYXRhSWQoKX07XG4gICAgdGhpcy50ZW5zb3JNYXAuc2V0KGRhdGFJZCwge2R0eXBlLCBzaGFwZSwgdmFsdWVzLCByZWZDb3VudDogMX0pO1xuICAgIHJldHVybiBkYXRhSWQ7XG4gIH1cblxuICBvdmVycmlkZSBtb3ZlKFxuICAgICAgZGF0YUlkOiBEYXRhSWQsIHZhbHVlczogQmFja2VuZFZhbHVlcywgc2hhcGU6IG51bWJlcltdLCBkdHlwZTogRGF0YVR5cGUsXG4gICAgICByZWZDb3VudDogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKGR0eXBlID09PSAnY29tcGxleDY0Jykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3Qgd3JpdGUgdG8gYSBjb21wbGV4NjQgZHR5cGUuIGAgK1xuICAgICAgICAgIGBQbGVhc2UgdXNlIHRmLmNvbXBsZXgocmVhbCwgaW1hZykuYCk7XG4gICAgfVxuICAgIHRoaXMudGVuc29yTWFwLnNldChkYXRhSWQsIHtkdHlwZSwgc2hhcGUsIHZhbHVlcywgcmVmQ291bnR9KTtcbiAgfVxuXG4gIHN1Ym1pdFF1ZXVlKCkge1xuICAgIHRoaXMucXVldWUuc3VibWl0KFt0aGlzLmNvbW1hbmRFbmNvZGVyLmZpbmlzaCgpXSk7XG4gICAgdGhpcy5jb21tYW5kRW5jb2RlciA9IG51bGw7XG4gICAgdGhpcy5kaXNwYXRjaENvdW50SW5QYXNzID0gMDtcblxuICAgIHRoaXMuY29tbWFuZFF1ZXVlT3duZWRJZHMgPSBuZXcgV2Vha1NldDxEYXRhSWQ+KCk7XG5cbiAgICB0aGlzLnRlbnNvckRhdGFQZW5kaW5nRGlzcG9zYWwuZm9yRWFjaChkID0+IHtcbiAgICAgIHRoaXMucmVsZWFzZVJlc291cmNlKGQpO1xuICAgICAgdGhpcy50ZW5zb3JNYXAuZGVsZXRlKGQpO1xuICAgIH0pO1xuXG4gICAgdGhpcy51bmlmb3JtUGVuZGluZ0Rpc3Bvc2FsLmZvckVhY2goXG4gICAgICAgIGIgPT4gdGhpcy5idWZmZXJNYW5hZ2VyLnJlbGVhc2VCdWZmZXIoYikpO1xuICAgIHRoaXMuc3RhZ2luZ1BlbmRpbmdEaXNwb3NhbC5mb3JFYWNoKFxuICAgICAgICBiID0+IHRoaXMuYnVmZmVyTWFuYWdlci5yZWxlYXNlQnVmZmVyKGIsIGZhbHNlKSk7XG5cbiAgICB0aGlzLnRlbnNvckRhdGFQZW5kaW5nRGlzcG9zYWwgPSBbXTtcbiAgICB0aGlzLnVuaWZvcm1QZW5kaW5nRGlzcG9zYWwgPSBbXTtcbiAgICB0aGlzLnN0YWdpbmdQZW5kaW5nRGlzcG9zYWwgPSBbXTtcbiAgfVxuXG4gIGVuc3VyZUNvbW1hbmRFbmNvZGVyUmVhZHkoKSB7XG4gICAgaWYgKCF0aGlzLmNvbW1hbmRFbmNvZGVyKSB7XG4gICAgICB0aGlzLmNvbW1hbmRFbmNvZGVyID0gdGhpcy5kZXZpY2UuY3JlYXRlQ29tbWFuZEVuY29kZXIoKTtcbiAgICB9XG4gIH1cblxuICBlbmRDb21wdXRlUGFzc0VuY29kZXIoKSB7XG4gICAgaWYgKHRoaXMuY29tcHV0ZVBhc3NFbmNvZGVyKSB7XG4gICAgICB0aGlzLmNvbXB1dGVQYXNzRW5jb2Rlci5lbmQoKTtcbiAgICAgIHRoaXMuY29tcHV0ZVBhc3NFbmNvZGVyID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvLyBDaGVjayBpZiBwYXJhbGxlbCBjb21waWxhdGlvbiBpcyBkb25lLlxuICBhc3luYyBjaGVja0NvbXBpbGVDb21wbGV0aW9uQXN5bmMoKSB7XG4gICAgbGV0IHBpcGVsaW5lczogR1BVQ29tcHV0ZVBpcGVsaW5lW107XG4gICAgdHJ5IHtcbiAgICAgIHBpcGVsaW5lcyA9IGF3YWl0IFByb21pc2UuYWxsKE9iamVjdC52YWx1ZXModGhpcy5waXBlbGluZUNhY2hlKSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLy8gVE9ETzogQWRkIHRlc3QgY2FzZSB0byBjYXRjaCB0aGlzIGV4Y2VwdGlvbi5cbiAgICAgIHRocm93IG5ldyBFcnJvcihlLm1lc3NhZ2UpO1xuICAgIH1cbiAgICBPYmplY3Qua2V5cyh0aGlzLnBpcGVsaW5lQ2FjaGUpLm1hcCgoa2V5LCBpKSA9PiB7XG4gICAgICB0aGlzLnBpcGVsaW5lQ2FjaGVba2V5XSA9IHBpcGVsaW5lc1tpXTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRCdWZmZXJEYXRhKGJ1ZmZlcjogR1BVQnVmZmVyKTogUHJvbWlzZTxBcnJheUJ1ZmZlcj4ge1xuICAgIGlmIChlbnYoKS5nZXRCb29sKCdXRUJHUFVfRU5HSU5FX0NPTVBJTEVfT05MWScpKSB7XG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgJ1RoZSBkYXRhIG1heSBiZSBpbnZhbGlkIHNpbmNlIFdFQkdQVV9FTkdJTkVfQ09NUElMRV9PTkxZIGlzIHRydWUsIHRoaXMgY2FuIG9ubHkgYmUgY2FsbGVkIHdoZW4gV0VCR1BVX0VOR0lORV9DT01QSUxFX09OTFkgaXMgZmFsc2UnKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBzaXplID0gYnVmZmVyLnNpemU7XG4gICAgY29uc3Qgc3RhZ2luZ0J1ZmZlciA9IHRoaXMuYnVmZmVyTWFuYWdlci5hY3F1aXJlQnVmZmVyKFxuICAgICAgICBzaXplLCBHUFVCdWZmZXJVc2FnZS5DT1BZX0RTVCB8IEdQVUJ1ZmZlclVzYWdlLk1BUF9SRUFEKTtcbiAgICB0aGlzLmVuc3VyZUNvbW1hbmRFbmNvZGVyUmVhZHkoKTtcbiAgICB0aGlzLmVuZENvbXB1dGVQYXNzRW5jb2RlcigpO1xuICAgIHRoaXMuY29tbWFuZEVuY29kZXIuY29weUJ1ZmZlclRvQnVmZmVyKGJ1ZmZlciwgMCwgc3RhZ2luZ0J1ZmZlciwgMCwgc2l6ZSk7XG4gICAgdGhpcy5zdWJtaXRRdWV1ZSgpO1xuXG4gICAgYXdhaXQgc3RhZ2luZ0J1ZmZlci5tYXBBc3luYyhHUFVNYXBNb2RlLlJFQUQpO1xuICAgIGNvbnN0IHZhbHVlcyA9IHN0YWdpbmdCdWZmZXIuZ2V0TWFwcGVkUmFuZ2UoKS5zbGljZSgwKTtcblxuICAgIHN0YWdpbmdCdWZmZXIudW5tYXAoKTtcbiAgICBpZiAoc3RhZ2luZ0J1ZmZlciAhPSBudWxsKSB7XG4gICAgICB0aGlzLmJ1ZmZlck1hbmFnZXIucmVsZWFzZUJ1ZmZlcihzdGFnaW5nQnVmZmVyKTtcbiAgICB9XG5cbiAgICAvLyBOZWVkIHRvIGdldCB0ZXh0dXJlIGZyb20gc3dhcENoYWluIHRvIGVuYWJsZSBwcm9maWxpbmcgdG9vbFxuICAgIC8vIHRvIGNhcHR1cmUgYSBmcmFtZVxuICAgIGlmIChlbnYoKS5nZXRCb29sKCdXRUJHUFVfVVNFX1BST0ZJTEVfVE9PTCcpKSB7XG4gICAgICB1dGlsLmFzc2VydChcbiAgICAgICAgICB0aGlzLmR1bW15Q29udGV4dCAhPT0gdW5kZWZpbmVkLFxuICAgICAgICAgICgpID0+IGBGYWlsIHRvIGdldCBjb250ZXh0IGZvciBwcm9maWxpbmcgdG9vbGApO1xuICAgICAgdGhpcy5kdW1teUNvbnRleHQuZ2V0Q3VycmVudFRleHR1cmUoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdmFsdWVzO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0QW5kQ2FjaGVPbkNQVShkYXRhSWQ6IERhdGFJZCwgZGF0YTogQmFja2VuZFZhbHVlcyk6XG4gICAgICBCYWNrZW5kVmFsdWVzIHtcbiAgICBjb25zdCB0ZW5zb3JEYXRhID0gdGhpcy50ZW5zb3JNYXAuZ2V0KGRhdGFJZCk7XG4gICAgdGVuc29yRGF0YS52YWx1ZXMgPSBkYXRhO1xuICAgIHJldHVybiB0ZW5zb3JEYXRhLnZhbHVlcztcbiAgfVxuXG4gIG92ZXJyaWRlIHJlYWRTeW5jKGRhdGFJZDogb2JqZWN0KTogQmFja2VuZFZhbHVlcyB7XG4gICAgY29uc3QgdGVuc29yRGF0YSA9IHRoaXMudGVuc29yTWFwLmdldChkYXRhSWQpO1xuICAgIGNvbnN0IHt2YWx1ZXMsIGNvbXBsZXhUZW5zb3JJbmZvc30gPSB0ZW5zb3JEYXRhO1xuXG4gICAgaWYgKHZhbHVlcyAhPSBudWxsIHx8IHRlbnNvckRhdGEuZHR5cGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gdmFsdWVzO1xuICAgIH1cblxuICAgIGlmICh0ZW5zb3JEYXRhLmR0eXBlID09PSAnY29tcGxleDY0Jykge1xuICAgICAgY29uc3QgcmVhbFZhbHVlcyA9XG4gICAgICAgICAgdGhpcy5yZWFkU3luYyhjb21wbGV4VGVuc29ySW5mb3MucmVhbC5kYXRhSWQpIGFzIEZsb2F0MzJBcnJheTtcbiAgICAgIGNvbnN0IGltYWdWYWx1ZXMgPVxuICAgICAgICAgIHRoaXMucmVhZFN5bmMoY29tcGxleFRlbnNvckluZm9zLmltYWcuZGF0YUlkKSBhcyBGbG9hdDMyQXJyYXk7XG4gICAgICBjb25zdCBjb21wbGV4VmFscyA9IHV0aWwuY29udmVydEJhY2tlbmRWYWx1ZXNBbmRBcnJheUJ1ZmZlcihcbiAgICAgICAgICBiYWNrZW5kX3V0aWwubWVyZ2VSZWFsQW5kSW1hZ0FycmF5cyhyZWFsVmFsdWVzLCBpbWFnVmFsdWVzKS5idWZmZXIsXG4gICAgICAgICAgJ2Zsb2F0MzInKTtcbiAgICAgIHRoaXMuY29udmVydEFuZENhY2hlT25DUFUoZGF0YUlkLCBjb21wbGV4VmFscyk7XG4gICAgICByZXR1cm4gY29tcGxleFZhbHM7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmhhc1JlYWRTeW5jV2FybmVkKSB7XG4gICAgICB0aGlzLmhhc1JlYWRTeW5jV2FybmVkID0gdHJ1ZTtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICBgVGhlIHBlcmZvcm1hbmNlIG9mIHN5bmNocm9ub3VzbHkgcmVhZGluZyBkYXRhIGZyb20gR1BVIHRvIENQVSBpcyBgICtcbiAgICAgICAgICBgcG9vciBvbiB0aGUgd2ViZ3B1IGJhY2tlbmQsIHBsZWFzZSB1c2UgYXN5bmNocm9ub3VzIEFQSXMgaW5zdGVhZC5gKTtcbiAgICB9XG5cbiAgICBjb25zdCBhbHBoYU1vZGVzOiBHUFVDYW52YXNBbHBoYU1vZGVbXSA9IFsnb3BhcXVlJywgJ3ByZW11bHRpcGxpZWQnXTtcblxuICAgIGNvbnN0IGJ1ZmZlciA9IHRlbnNvckRhdGEucmVzb3VyY2UgYXMgR1BVQnVmZmVyO1xuICAgIGNvbnN0IGJ1ZmZlclNpemUgPSBidWZmZXIuc2l6ZTtcbiAgICB1dGlsLmFzc2VydChcbiAgICAgICAgYnVmZmVyU2l6ZSAlIDQgPT09IDAsXG4gICAgICAgICgpID0+ICdCZWNhdXNlIHRoZXJlIGlzIDQgYnl0ZXMgZm9yICcgK1xuICAgICAgICAgICAgJ29uZSBwaXhlbCwgYnVmZmVyIHNpemUgbXVzdCBiZSBtdWx0aXBsZSBvZiA0LicpO1xuICAgIGNvbnN0IHBpeGVsc1NpemUgPSBidWZmZXJTaXplIC8gNDtcbiAgICBjb25zdCB2YWxzR1BVID0gbmV3IEFycmF5QnVmZmVyKGJ1ZmZlclNpemUpO1xuICAgIC8vIFRPRE86IGFkanVzdCB0aGUgcmVhZGluZyB3aW5kb3cgc2l6ZSBhY2NvcmRpbmcgdGhlIGBidWZmZXJTaXplYC5cbiAgICBjb25zdCBjYW52YXNXaWR0aCA9IDI1NiwgY2FudmFzSGVpZ2h0ID0gMjU2O1xuICAgIGNvbnN0IHN0YWdpbmdEZXZpY2VTdG9yYWdlOiBPZmZzY3JlZW5DYW52YXNbXSA9XG4gICAgICAgIGFscGhhTW9kZXMubWFwKF8gPT4gbmV3IE9mZnNjcmVlbkNhbnZhcyhjYW52YXNXaWR0aCwgY2FudmFzSGVpZ2h0KSk7XG4gICAgY29uc3Qgc3RhZ2luZ0hvc3RTdG9yYWdlID0gbmV3IE9mZnNjcmVlbkNhbnZhcyhjYW52YXNXaWR0aCwgY2FudmFzSGVpZ2h0KTtcblxuICAgIHRoaXMuZW5kQ29tcHV0ZVBhc3NFbmNvZGVyKCk7XG4gICAgc3RhZ2luZ0RldmljZVN0b3JhZ2VcbiAgICAgICAgLm1hcCgoc3RvcmFnZSwgaW5kZXgpID0+IHtcbiAgICAgICAgICBjb25zdCBjb250ZXh0ID0gc3RvcmFnZS5nZXRDb250ZXh0KCd3ZWJncHUnKTtcbiAgICAgICAgICAvLyBUT0RPOiB1c2UgcmdiYTh1bm9ybSBmb3JtYXQgd2hlbiB0aGlzIGZvcm1hdCBpcyBzdXBwb3J0ZWQgb24gTWFjLlxuICAgICAgICAgIC8vIGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTEyOTg2MThcbiAgICAgICAgICBjb250ZXh0LmNvbmZpZ3VyZSh7XG4gICAgICAgICAgICBkZXZpY2U6IHRoaXMuZGV2aWNlLFxuICAgICAgICAgICAgZm9ybWF0OiAnYmdyYTh1bm9ybScsXG4gICAgICAgICAgICB1c2FnZTogR1BVVGV4dHVyZVVzYWdlLkNPUFlfRFNULFxuICAgICAgICAgICAgYWxwaGFNb2RlOiBhbHBoYU1vZGVzW2luZGV4XSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZXR1cm4gY29udGV4dC5nZXRDdXJyZW50VGV4dHVyZSgpO1xuICAgICAgICB9KVxuICAgICAgICAubWFwKCh0ZXh0dXJlLCBpbmRleCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGJ5dGVzUGVyUm93ID0gY2FudmFzV2lkdGggKiA0O1xuICAgICAgICAgIGNvbnN0IHJlYWREYXRhR1BVVG9DUFUgPVxuICAgICAgICAgICAgICAod2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIsIG9mZnNldDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5lbnN1cmVDb21tYW5kRW5jb2RlclJlYWR5KCk7XG4gICAgICAgICAgICAgICAgdGhpcy5jb21tYW5kRW5jb2Rlci5jb3B5QnVmZmVyVG9UZXh0dXJlKFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgYnVmZmVyLFxuICAgICAgICAgICAgICAgICAgICAgIGJ5dGVzUGVyUm93LFxuICAgICAgICAgICAgICAgICAgICAgIG9mZnNldCxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgIHRleHR1cmUsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICB3aWR0aCxcbiAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQsXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRoaXMuc3VibWl0UXVldWUoKTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRleHQgPSBzdGFnaW5nSG9zdFN0b3JhZ2UuZ2V0Q29udGV4dCgnMmQnLCB7XG4gICAgICAgICAgICAgICAgICB3aWxsUmVhZEZyZXF1ZW50bHk6IHRydWUsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgY29udGV4dC5jbGVhclJlY3QoMCwgMCwgd2lkdGgsIGhlaWdodCk7XG4gICAgICAgICAgICAgICAgY29udGV4dC5kcmF3SW1hZ2Uoc3RhZ2luZ0RldmljZVN0b3JhZ2VbaW5kZXhdLCAwLCAwKTtcbiAgICAgICAgICAgICAgICBjb25zdCBzdGFnaW5nVmFsdWVzID1cbiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5nZXRJbWFnZURhdGEoMCwgMCwgd2lkdGgsIGhlaWdodCkuZGF0YTtcbiAgICAgICAgICAgICAgICBjb25zdCBhbHBoYU1vZGUgPSBhbHBoYU1vZGVzW2luZGV4XTtcbiAgICAgICAgICAgICAgICBjb25zdCBzcGFuID1cbiAgICAgICAgICAgICAgICAgICAgbmV3IFVpbnQ4Q2xhbXBlZEFycmF5KHZhbHNHUFUsIG9mZnNldCwgd2lkdGggKiBoZWlnaHQgKiA0KTtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IHNwYW4ubGVuZ3RoOyBrICs9IDQpIHtcbiAgICAgICAgICAgICAgICAgIGlmIChhbHBoYU1vZGUgPT09ICdwcmVtdWx0aXBsaWVkJykge1xuICAgICAgICAgICAgICAgICAgICBzcGFuW2sgKyAzXSA9IHN0YWdpbmdWYWx1ZXNbayArIDNdO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBzdGFnaW5nVmFsdWVzW2tdO1xuICAgICAgICAgICAgICAgICAgICBzcGFuW2tdID0gc3RhZ2luZ1ZhbHVlc1trICsgMl07XG4gICAgICAgICAgICAgICAgICAgIHNwYW5bayArIDFdID0gc3RhZ2luZ1ZhbHVlc1trICsgMV07XG4gICAgICAgICAgICAgICAgICAgIHNwYW5bayArIDJdID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgY29uc3QgZnVsbHlSZWFkQ291bnQgPVxuICAgICAgICAgICAgICBNYXRoLmZsb29yKHBpeGVsc1NpemUgLyAoY2FudmFzV2lkdGggKiBjYW52YXNIZWlnaHQpKTtcbiAgICAgICAgICBsZXQgd2lkdGggPSBjYW52YXNXaWR0aCwgaGVpZ2h0ID0gY2FudmFzSGVpZ2h0LCBvZmZzZXQgPSAwO1xuICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZnVsbHlSZWFkQ291bnQ7IGkrKykge1xuICAgICAgICAgICAgLy8gUmVhZCB0aGUgYnVmZmVyIGRhdGEsIHdoaWNoIGZ1bGx5IGZpbGwgdGhlIHdob2xlIGNhbnZhcy5cbiAgICAgICAgICAgIHJlYWREYXRhR1BVVG9DUFUod2lkdGgsIGhlaWdodCwgb2Zmc2V0KTtcbiAgICAgICAgICAgIG9mZnNldCArPSBjYW52YXNXaWR0aCAqIGNhbnZhc0hlaWdodCAqIDQ7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3QgcmVtYWluU2l6ZSA9IHBpeGVsc1NpemUgJSAoY2FudmFzV2lkdGggKiBjYW52YXNIZWlnaHQpO1xuICAgICAgICAgIGhlaWdodCA9IE1hdGguZmxvb3IocmVtYWluU2l6ZSAvIGNhbnZhc1dpZHRoKTtcbiAgICAgICAgICBpZiAoaGVpZ2h0ID4gMCkge1xuICAgICAgICAgICAgLy8gUmVhZCB0aGUgYnVmZmVyIGRhdGEsIHdoaWNoIGZ1bGx5IGZpbGwgY2VydGFpbiByb3dzIG9mIGNhbnZhcy5cbiAgICAgICAgICAgIHJlYWREYXRhR1BVVG9DUFUod2lkdGgsIGhlaWdodCwgb2Zmc2V0KTtcbiAgICAgICAgICAgIG9mZnNldCArPSBoZWlnaHQgKiAoY2FudmFzV2lkdGggKiA0KTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB3aWR0aCA9IHJlbWFpblNpemUgJSBjYW52YXNXaWR0aDtcbiAgICAgICAgICBpZiAod2lkdGggPiAwKSB7XG4gICAgICAgICAgICAvLyBSZWFkIHRoZSBidWZmZXIgZGF0YSwgd2hpY2ggbm90IGZ1bGx5IGZpbGwgb25lIHJvdyBvZiBjYW52YXMuXG4gICAgICAgICAgICByZWFkRGF0YUdQVVRvQ1BVKHdpZHRoLCAxLCBvZmZzZXQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICBjb25zdCB2YWxzID1cbiAgICAgICAgdXRpbC5jb252ZXJ0QmFja2VuZFZhbHVlc0FuZEFycmF5QnVmZmVyKHZhbHNHUFUsIHRlbnNvckRhdGEuZHR5cGUpO1xuICAgIHRoaXMuY29udmVydEFuZENhY2hlT25DUFUoZGF0YUlkLCB2YWxzKTtcbiAgICByZXR1cm4gdmFscztcbiAgfVxuXG4gIG92ZXJyaWRlIGFzeW5jIHJlYWQoZGF0YUlkOiBvYmplY3QpOiBQcm9taXNlPEJhY2tlbmRWYWx1ZXM+IHtcbiAgICBpZiAoIXRoaXMudGVuc29yTWFwLmhhcyhkYXRhSWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRlbnNvciAke2RhdGFJZH0gd2FzIG5vdCByZWdpc3RlcmVkIWApO1xuICAgIH1cbiAgICBjb25zdCB0ZW5zb3JEYXRhID0gdGhpcy50ZW5zb3JNYXAuZ2V0KGRhdGFJZCk7XG5cbiAgICBjb25zdCB7dmFsdWVzfSA9IHRlbnNvckRhdGE7XG5cbiAgICBpZiAodmFsdWVzICE9IG51bGwpIHtcbiAgICAgIHJldHVybiB2YWx1ZXM7XG4gICAgfVxuXG4gICAgLy8gRG93bmxvYWQgdGhlIHZhbHVlcyBmcm9tIHRoZSBHUFUuXG4gICAgbGV0IHZhbHM6IEJhY2tlbmRWYWx1ZXM7XG4gICAgaWYgKHRlbnNvckRhdGEuZHR5cGUgPT09ICdjb21wbGV4NjQnKSB7XG4gICAgICBjb25zdCBwcyA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgdGhpcy5yZWFkKHRlbnNvckRhdGEuY29tcGxleFRlbnNvckluZm9zLnJlYWwuZGF0YUlkKSxcbiAgICAgICAgdGhpcy5yZWFkKHRlbnNvckRhdGEuY29tcGxleFRlbnNvckluZm9zLmltYWcuZGF0YUlkKVxuICAgICAgXSk7XG5cbiAgICAgIGNvbnN0IHJlYWxWYWx1ZXMgPSBwc1swXTtcbiAgICAgIGNvbnN0IGltYWdWYWx1ZXMgPSBwc1sxXTtcbiAgICAgIHZhbHMgPSBiYWNrZW5kX3V0aWwubWVyZ2VSZWFsQW5kSW1hZ0FycmF5cyhcbiAgICAgICAgICByZWFsVmFsdWVzIGFzIEZsb2F0MzJBcnJheSwgaW1hZ1ZhbHVlcyBhcyBGbG9hdDMyQXJyYXkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5nZXRCdWZmZXJEYXRhKHRlbnNvckRhdGEucmVzb3VyY2UgYXMgR1BVQnVmZmVyKTtcbiAgICAgIHZhbHMgPSB1dGlsLmNvbnZlcnRCYWNrZW5kVmFsdWVzQW5kQXJyYXlCdWZmZXIoZGF0YSwgdGVuc29yRGF0YS5kdHlwZSk7XG4gICAgfVxuICAgIHRoaXMuY29udmVydEFuZENhY2hlT25DUFUoZGF0YUlkLCB2YWxzKTtcbiAgICByZXR1cm4gdmFscztcbiAgfVxuXG4gIC8vIFRoZSBzb3VyY2UgR1BVQnVmZmVyIGFuZCBkZXN0aW5hdGlvbiBHUFVCdWZmZXIgaGF2ZSB0aGUgc2FtZSBzaXplIGFuZFxuICAvLyB1c2FnZS5cbiAgcHJpdmF0ZSBjb3B5QnVmZmVyKHNyY0J1ZmZlcjogR1BVQnVmZmVyKSB7XG4gICAgY29uc3Qgc2l6ZSA9IHNyY0J1ZmZlci5zaXplO1xuICAgIGNvbnN0IHVzYWdlID0gc3JjQnVmZmVyLnVzYWdlO1xuICAgIGNvbnN0IGRzdEJ1ZmZlciA9IHRoaXMuYnVmZmVyTWFuYWdlci5hY3F1aXJlQnVmZmVyKHNpemUsIHVzYWdlKTtcbiAgICB0aGlzLmVuc3VyZUNvbW1hbmRFbmNvZGVyUmVhZHkoKTtcbiAgICB0aGlzLmVuZENvbXB1dGVQYXNzRW5jb2RlcigpO1xuICAgIHRoaXMuY29tbWFuZEVuY29kZXIuY29weUJ1ZmZlclRvQnVmZmVyKHNyY0J1ZmZlciwgMCwgZHN0QnVmZmVyLCAwLCBzaXplKTtcbiAgICB0aGlzLnN1Ym1pdFF1ZXVlKCk7XG4gICAgcmV0dXJuIGRzdEJ1ZmZlcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBURi5qcyB0ZW5zb3Igb3V0IG9mIGFuIGV4aXN0aW5nIFdlYkdQVSBidWZmZXIuXG4gICAqL1xuICBvdmVycmlkZSBjcmVhdGVUZW5zb3JGcm9tR1BVRGF0YShcbiAgICAgIHdlYkdQVURhdGE6IFdlYkdQVURhdGEsIHNoYXBlOiBudW1iZXJbXSwgZHR5cGU6IERhdGFUeXBlKTogVGVuc29yIHtcbiAgICBsZXQgYnVmZmVyID0gd2ViR1BVRGF0YS5idWZmZXI7XG4gICAgaWYgKGR0eXBlID09PSAnY29tcGxleDY0Jykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3Qgd3JpdGUgdG8gYSBjb21wbGV4NjQgZHR5cGUuIGApO1xuICAgIH1cbiAgICBjb25zdCBkYXRhSWQgPSB7aWQ6IHRoaXMubmV4dERhdGFJZCgpfTtcbiAgICB0aGlzLnRlbnNvck1hcC5zZXQoZGF0YUlkLCB7XG4gICAgICBkdHlwZSxcbiAgICAgIHNoYXBlLFxuICAgICAgdmFsdWVzOiBudWxsLFxuICAgICAgcmVmQ291bnQ6IDEsXG4gICAgICBleHRlcm5hbDogd2ViR1BVRGF0YS56ZXJvQ29weVxuICAgIH0pO1xuICAgIGNvbnN0IHRlbnNvckRhdGEgPSB0aGlzLnRlbnNvck1hcC5nZXQoZGF0YUlkKTtcbiAgICBjb25zdCBzaXplID0gd2ViZ3B1X3V0aWwuR1BVQnl0ZXNQZXJFbGVtZW50KHRlbnNvckRhdGEuZHR5cGUpICpcbiAgICAgICAgdXRpbC5zaXplRnJvbVNoYXBlKHRlbnNvckRhdGEuc2hhcGUpO1xuICAgIGlmICh3ZWJHUFVEYXRhLmJ1ZmZlci5zaXplIDwgc2l6ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBHUFVCdWZmZXIgc2l6ZSgke1xuICAgICAgICAgIHdlYkdQVURhdGEuYnVmZmVyLnNpemV9KSBpcyBzbWFsbGVyIHRoYW4gdGVuc29yIHNpemUoJHtzaXplfSkhYCk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgICAgKHdlYkdQVURhdGEuYnVmZmVyLnVzYWdlICZcbiAgICAgICAgIChHUFVCdWZmZXJVc2FnZS5TVE9SQUdFIHwgR1BVQnVmZmVyVXNhZ2UuQ09QWV9TUkMpKSAhPT1cbiAgICAgICAgKEdQVUJ1ZmZlclVzYWdlLlNUT1JBR0UgfCBHUFVCdWZmZXJVc2FnZS5DT1BZX1NSQykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAnR1BVQnVmZmVyLnVzYWdlIHNob3VsZCBpbmNsdWRlIEdQVUJ1ZmZlclVzYWdlLlNUT1JBR0UgfCBHUFVCdWZmZXJVc2FnZS5DT1BZX1NSQyEnKTtcbiAgICB9XG5cbiAgICAvLyBEbyBidWZmZXIgY29weSBieSBkZWZhdWx0LlxuICAgIGlmICh3ZWJHUFVEYXRhLnplcm9Db3B5ICE9PSB0cnVlKSB7XG4gICAgICBidWZmZXIgPSB0aGlzLmNvcHlCdWZmZXIoYnVmZmVyKTtcbiAgICB9XG4gICAgdGVuc29yRGF0YS5yZXNvdXJjZSA9IGJ1ZmZlcjtcbiAgICByZXR1cm4gZW5naW5lKCkubWFrZVRlbnNvckZyb21EYXRhSWQoZGF0YUlkLCBzaGFwZSwgZHR5cGUsIHRoaXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlYWQgdGVuc29yIHRvIGEgbmV3IEdQVUJ1ZmZlci5cbiAgICogQHBhcmFtIGRhdGFJZCBUaGUgc291cmNlIHRlbnNvci5cbiAgICovXG4gIG92ZXJyaWRlIHJlYWRUb0dQVShkYXRhSWQ6IERhdGFJZCk6IEdQVURhdGEge1xuICAgIGNvbnN0IHNyY1RlbnNvckRhdGEgPSB0aGlzLnRlbnNvck1hcC5nZXQoZGF0YUlkKTtcbiAgICBjb25zdCB7dmFsdWVzLCBkdHlwZSwgc2hhcGUsIHJlc291cmNlfSA9IHNyY1RlbnNvckRhdGE7XG5cbiAgICBpZiAoZHR5cGUgPT09ICdjb21wbGV4NjQnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvZXMgbm90IHN1cHBvcnQgcmVhZGluZyBidWZmZXIgZm9yIGNvbXBsZXg2NCBkdHlwZS4nKTtcbiAgICB9XG5cbiAgICBpZiAocmVzb3VyY2UgPT0gbnVsbCkge1xuICAgICAgaWYgKHZhbHVlcyAhPSBudWxsKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRGF0YSBpcyBub3Qgb24gR1BVIGJ1dCBvbiBDUFUuJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZXJlIGlzIG5vIGRhdGEgb24gR1BVIG9yIENQVS4nKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBzcmNCdWZmZXIgPSByZXNvdXJjZSBhcyBHUFVCdWZmZXI7XG4gICAgY29uc3Qgc2l6ZSA9IHNyY0J1ZmZlci5zaXplO1xuICAgIGNvbnN0IHVzYWdlID0gc3JjQnVmZmVyLnVzYWdlO1xuICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuYnVmZmVyTWFuYWdlci5hY3F1aXJlQnVmZmVyKHNpemUsIHVzYWdlKTtcbiAgICB0aGlzLmVuc3VyZUNvbW1hbmRFbmNvZGVyUmVhZHkoKTtcbiAgICB0aGlzLmVuZENvbXB1dGVQYXNzRW5jb2RlcigpO1xuICAgIHRoaXMuY29tbWFuZEVuY29kZXIuY29weUJ1ZmZlclRvQnVmZmVyKFxuICAgICAgICByZXNvdXJjZSBhcyBHUFVCdWZmZXIsIDAsIGJ1ZmZlciwgMCwgc2l6ZSk7XG4gICAgdGhpcy5zdWJtaXRRdWV1ZSgpO1xuXG4gICAgY29uc3QgdGVuc29ySW5mbyA9IHRoaXMubWFrZVRlbnNvckluZm8oc2hhcGUsIGR0eXBlKTtcbiAgICAvLyBNYWtlIGVuZ2luZSB0cmFjayB0aGlzIHRlbnNvciwgc28gdGhhdCB3ZSBjYW4gZGlzcG9zZSBpdCBsYXRlci5cbiAgICBjb25zdCB0ZW5zb3JSZWYgPSBlbmdpbmUoKS5tYWtlVGVuc29yRnJvbVRlbnNvckluZm8odGVuc29ySW5mbyk7XG5cbiAgICBjb25zdCB0ZW5zb3JEYXRhID0gdGhpcy50ZW5zb3JNYXAuZ2V0KHRlbnNvckluZm8uZGF0YUlkKTtcbiAgICB0ZW5zb3JEYXRhLnJlc291cmNlID0gYnVmZmVyO1xuXG4gICAgcmV0dXJuIHt0ZW5zb3JSZWYsIGJ1ZmZlcn07XG4gIH1cblxuICBidWZmZXJTeW5jPFIgZXh0ZW5kcyBSYW5rLCBEIGV4dGVuZHMgRGF0YVR5cGU+KHQ6IFRlbnNvckluZm8pOlxuICAgICAgVGVuc29yQnVmZmVyPFIsIEQ+IHtcbiAgICBjb25zdCBkYXRhID0gdGhpcy5yZWFkU3luYyh0LmRhdGFJZCk7XG4gICAgaWYgKHQuZHR5cGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICB0cnkge1xuICAgICAgICAvLyBEZWNvZGUgdGhlIGJ5dGVzIGludG8gc3RyaW5nLlxuICAgICAgICBjb25zdCBzdHJpbmdzID0gKGRhdGEgYXMgVWludDhBcnJheVtdKS5tYXAoZCA9PiB1dGlsLmRlY29kZVN0cmluZyhkKSk7XG4gICAgICAgIHJldHVybiBidWZmZXIodC5zaGFwZSBhcyBTaGFwZU1hcFtSXSwgdC5kdHlwZSwgc3RyaW5ncykgYXNcbiAgICAgICAgICAgIFRlbnNvckJ1ZmZlcjxSLCBEPjtcbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBkZWNvZGUgZW5jb2RlZCBzdHJpbmcgYnl0ZXMgaW50byB1dGYtOCcpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gYnVmZmVyKHQuc2hhcGUgYXMgU2hhcGVNYXBbUl0sIHQuZHR5cGUsIGRhdGEgYXMgVHlwZWRBcnJheSkgYXNcbiAgICAgICAgVGVuc29yQnVmZmVyPFIsIEQ+O1xuICB9XG5cbiAgb3ZlcnJpZGUgYXN5bmMgdGltZShmOiAoKSA9PiB2b2lkKTogUHJvbWlzZTxXZWJHUFVUaW1pbmdJbmZvPiB7XG4gICAgaWYgKCF0aGlzLnN1cHBvcnRUaW1lc3RhbXBRdWVyeSAmJiAhdGhpcy5oYXNUaW1lc3RhbXBRdWVyeVdhcm5lZCkge1xuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgIGBUaGlzIGRldmljZSBkb2Vzbid0IHN1cHBvcnQgdGltZXN0YW1wLXF1ZXJ5IGV4dGVuc2lvbi4gYCArXG4gICAgICAgICAgYFN0YXJ0IENocm9tZSBicm93c2VyIHdpdGggZmxhZyBgICtcbiAgICAgICAgICBgLS1kaXNhYmxlLWRhd24tZmVhdHVyZXM9ZGlzYWxsb3dfdW5zYWZlX2FwaXMgdG8gdHJ5IGl0IGFnYWluLiBgICtcbiAgICAgICAgICBgT3RoZXJ3aXNlLCB6ZXJvIHdpbGwgYmUgc2hvd24gZm9yIHRoZSBrZXJuZWwgdGltZSB3aGVuIHByb2ZpbGluZyBgICtcbiAgICAgICAgICBgbW9kZSBpcyBlbmFibGVkLmApO1xuICAgICAgdGhpcy5oYXNUaW1lc3RhbXBRdWVyeVdhcm5lZCA9IHRydWU7XG4gICAgfVxuXG4gICAgY29uc3Qgb2xkQWN0aXZlVGltZXJzID0gdGhpcy5hY3RpdmVUaW1lcnM7XG4gICAgY29uc3QgbmV3QWN0aXZlVGltZXJzOiBUaW1lck5vZGVbXSA9IFtdO1xuXG4gICAgbGV0IG91dGVyTW9zdFRpbWUgPSBmYWxzZTtcbiAgICBpZiAodGhpcy5wcm9ncmFtVGltZXJzU3RhY2sgPT0gbnVsbCkge1xuICAgICAgdGhpcy5wcm9ncmFtVGltZXJzU3RhY2sgPSBuZXdBY3RpdmVUaW1lcnM7XG4gICAgICBvdXRlck1vc3RUaW1lID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5hY3RpdmVUaW1lcnMucHVzaChuZXdBY3RpdmVUaW1lcnMpO1xuICAgIH1cbiAgICB0aGlzLmFjdGl2ZVRpbWVycyA9IG5ld0FjdGl2ZVRpbWVycztcblxuICAgIGYoKTtcblxuICAgIGNvbnN0IGZsYXR0ZW5lZEFjdGl2ZVRpbWVyUXVlcmllcyA9XG4gICAgICAgIHV0aWwuZmxhdHRlbih0aGlzLmFjdGl2ZVRpbWVycy5tYXAoKGQ6IFdlYkdQVUtlcm5lbEluZm8pID0+IGQucXVlcnkpKVxuICAgICAgICAgICAgLmZpbHRlcihkID0+IGQgIT0gbnVsbCk7XG4gICAgY29uc3QgZmxhdHRlbmVkQWN0aXZlVGltZXJOYW1lcyA9XG4gICAgICAgIHV0aWwuZmxhdHRlbih0aGlzLmFjdGl2ZVRpbWVycy5tYXAoKGQ6IFdlYkdQVUtlcm5lbEluZm8pID0+IGQubmFtZSkpXG4gICAgICAgICAgICAuZmlsdGVyKGQgPT4gZCAhPSBudWxsKTtcblxuICAgIHRoaXMuYWN0aXZlVGltZXJzID0gb2xkQWN0aXZlVGltZXJzO1xuXG4gICAgaWYgKG91dGVyTW9zdFRpbWUpIHtcbiAgICAgIHRoaXMucHJvZ3JhbVRpbWVyc1N0YWNrID0gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgcmVzOiBXZWJHUFVUaW1pbmdJbmZvID0ge1xuICAgICAgdXBsb2FkV2FpdE1zOiB0aGlzLnVwbG9hZFdhaXRNcyxcbiAgICAgIGRvd25sb2FkV2FpdE1zOiB0aGlzLmRvd25sb2FkV2FpdE1zLFxuICAgICAga2VybmVsTXM6IG51bGwsXG4gICAgICB3YWxsTXM6IG51bGxcbiAgICB9O1xuXG4gICAgY29uc3Qga2VybmVsTXMgPSBhd2FpdCBQcm9taXNlLmFsbChmbGF0dGVuZWRBY3RpdmVUaW1lclF1ZXJpZXMpO1xuICAgIHJlc1sna2VybmVsTXMnXSA9IHV0aWwuc3VtKGtlcm5lbE1zKTtcbiAgICByZXNbJ2dldEV4dHJhUHJvZmlsZUluZm8nXSA9ICgpID0+XG4gICAgICAgIGtlcm5lbE1zLm1hcCgoZCwgaSkgPT4gKHtuYW1lOiBmbGF0dGVuZWRBY3RpdmVUaW1lck5hbWVzW2ldLCBtczogZH0pKVxuICAgICAgICAgICAgLm1hcChkID0+IGAke2QubmFtZX06ICR7ZC5tc31gKVxuICAgICAgICAgICAgLmpvaW4oJywgJyk7XG4gICAgdGhpcy51cGxvYWRXYWl0TXMgPSAwO1xuICAgIHRoaXMuZG93bmxvYWRXYWl0TXMgPSAwO1xuICAgIHJldHVybiByZXM7XG4gIH1cblxuICBtYWtlVGVuc29ySW5mbyhcbiAgICAgIHNoYXBlOiBudW1iZXJbXSwgZHR5cGU6IERhdGFUeXBlLFxuICAgICAgdmFsdWVzPzogQmFja2VuZFZhbHVlc3xzdHJpbmdbXSk6IFRlbnNvckluZm8ge1xuICAgIGlmIChkdHlwZSA9PT0gJ3N0cmluZycgJiYgdmFsdWVzICE9IG51bGwgJiYgdmFsdWVzLmxlbmd0aCA+IDAgJiZcbiAgICAgICAgdXRpbC5pc1N0cmluZyh2YWx1ZXNbMF0pKSB7XG4gICAgICB2YWx1ZXMgPSAodmFsdWVzIGFzIHVua25vd24gYXMgc3RyaW5nW10pLm1hcChkID0+IHV0aWwuZW5jb2RlU3RyaW5nKGQpKTtcbiAgICB9XG4gICAgY29uc3QgZGF0YUlkID0gdGhpcy53cml0ZSh2YWx1ZXMgYXMgQmFja2VuZFZhbHVlcywgc2hhcGUsIGR0eXBlKTtcbiAgICByZXR1cm4ge2RhdGFJZCwgc2hhcGUsIGR0eXBlfTtcbiAgfVxuXG4gIHByaXZhdGUgdGVuc29yVG9CaW5kaW5nKHRlbnNvcj86IFRlbnNvckluZm8pOiBHUFVCaW5kaW5nUmVzb3VyY2Uge1xuICAgIGlmICghdGVuc29yKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCB0ZW5zb3JEYXRhID0gdGhpcy50ZW5zb3JNYXAuZ2V0KHRlbnNvci5kYXRhSWQpO1xuICAgIGNvbnN0IHJlc291cmNlID0gdGVuc29yRGF0YS5yZXNvdXJjZTtcblxuICAgIGlmIChyZXNvdXJjZSBpbnN0YW5jZW9mIEdQVUJ1ZmZlcikge1xuICAgICAgcmV0dXJuIHtidWZmZXI6IHJlc291cmNlfTtcbiAgICB9XG4gICAgaWYgKHJlc291cmNlIGluc3RhbmNlb2YgR1BVVGV4dHVyZSkge1xuICAgICAgcmV0dXJuIHJlc291cmNlLmNyZWF0ZVZpZXcoKTtcbiAgICB9XG4gICAgLy8gR1BVRXh0ZXJuYWxUZXh0dXJlXG4gICAgcmV0dXJuIHJlc291cmNlO1xuICB9XG5cbiAgdXBsb2FkVG9HUFUoZGF0YUlkOiBEYXRhSWQpOiB2b2lkIHtcbiAgICBjb25zdCB0ZW5zb3JEYXRhID0gdGhpcy50ZW5zb3JNYXAuZ2V0KGRhdGFJZCk7XG4gICAgLy8gQWxyZWFkeSBvbiB0aGUgR1BVLlxuICAgIGlmICh0ZW5zb3JEYXRhLnJlc291cmNlICE9IG51bGwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBzaXplID0gd2ViZ3B1X3V0aWwuR1BVQnl0ZXNQZXJFbGVtZW50KHRlbnNvckRhdGEuZHR5cGUpICpcbiAgICAgICAgdXRpbC5zaXplRnJvbVNoYXBlKHRlbnNvckRhdGEuc2hhcGUpO1xuICAgIGxldCBidWZmZXI7XG4gICAgY29uc3QgdXNhZ2UgPSBHUFVCdWZmZXJVc2FnZS5TVE9SQUdFIHwgR1BVQnVmZmVyVXNhZ2UuQ09QWV9TUkMgfFxuICAgICAgICBHUFVCdWZmZXJVc2FnZS5DT1BZX0RTVDtcbiAgICBpZiAodGVuc29yRGF0YS52YWx1ZXMpIHtcbiAgICAgIGJ1ZmZlciA9IHRoaXMuYnVmZmVyTWFuYWdlci5hY3F1aXJlQnVmZmVyKHNpemUsIHVzYWdlLCB0cnVlKTtcbiAgICAgIGlmIChidWZmZXIubWFwU3RhdGUgPT09ICd1bm1hcHBlZCcpIHtcbiAgICAgICAgY29uc3Qgc3RhZ2luZ0J1ZmZlciA9IHRoaXMuYnVmZmVyTWFuYWdlci5hY3F1aXJlQnVmZmVyKFxuICAgICAgICAgICAgc2l6ZSwgR1BVQnVmZmVyVXNhZ2UuTUFQX1dSSVRFIHwgR1BVQnVmZmVyVXNhZ2UuQ09QWV9TUkMsIHRydWUsXG4gICAgICAgICAgICBmYWxzZSk7XG4gICAgICAgIGNvbnN0IGFycmF5QnVmZmVyID0gc3RhZ2luZ0J1ZmZlci5nZXRNYXBwZWRSYW5nZSgpO1xuICAgICAgICBpZiAodGVuc29yRGF0YS5kdHlwZSA9PT0gJ2ludDMyJyB8fCB0ZW5zb3JEYXRhLmR0eXBlID09PSAnYm9vbCcpIHtcbiAgICAgICAgICBuZXcgSW50MzJBcnJheShhcnJheUJ1ZmZlcikuc2V0KHRlbnNvckRhdGEudmFsdWVzIGFzIFR5cGVkQXJyYXkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG5ldyBGbG9hdDMyQXJyYXkoYXJyYXlCdWZmZXIpLnNldCh0ZW5zb3JEYXRhLnZhbHVlcyBhcyBGbG9hdDMyQXJyYXkpO1xuICAgICAgICB9XG4gICAgICAgIHN0YWdpbmdCdWZmZXIudW5tYXAoKTtcbiAgICAgICAgdGhpcy5lbnN1cmVDb21tYW5kRW5jb2RlclJlYWR5KCk7XG4gICAgICAgIHRoaXMuZW5kQ29tcHV0ZVBhc3NFbmNvZGVyKCk7XG4gICAgICAgIHRoaXMuY29tbWFuZEVuY29kZXIuY29weUJ1ZmZlclRvQnVmZmVyKFxuICAgICAgICAgICAgc3RhZ2luZ0J1ZmZlciwgMCwgYnVmZmVyLCAwLCBzaXplKTtcblxuICAgICAgICB0aGlzLnN0YWdpbmdQZW5kaW5nRGlzcG9zYWwucHVzaChzdGFnaW5nQnVmZmVyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGFycmF5QnVmZmVyID0gYnVmZmVyLmdldE1hcHBlZFJhbmdlKCk7XG4gICAgICAgIGlmICh0ZW5zb3JEYXRhLmR0eXBlID09PSAnaW50MzInIHx8IHRlbnNvckRhdGEuZHR5cGUgPT09ICdib29sJykge1xuICAgICAgICAgIG5ldyBJbnQzMkFycmF5KGFycmF5QnVmZmVyKS5zZXQodGVuc29yRGF0YS52YWx1ZXMgYXMgVHlwZWRBcnJheSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbmV3IEZsb2F0MzJBcnJheShhcnJheUJ1ZmZlcikuc2V0KHRlbnNvckRhdGEudmFsdWVzIGFzIEZsb2F0MzJBcnJheSk7XG4gICAgICAgIH1cbiAgICAgICAgYnVmZmVyLnVubWFwKCk7XG4gICAgICB9XG5cbiAgICAgIC8vIE9uY2UgdXBsb2FkZWQsIGRvbid0IHN0b3JlIHRoZSB2YWx1ZXMgb24gY3B1LlxuICAgICAgdGVuc29yRGF0YS52YWx1ZXMgPSBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICBidWZmZXIgPSB0aGlzLmJ1ZmZlck1hbmFnZXIuYWNxdWlyZUJ1ZmZlcihzaXplLCB1c2FnZSk7XG4gICAgfVxuICAgIHRlbnNvckRhdGEucmVzb3VyY2UgPSBidWZmZXI7XG4gIH1cblxuICBwcml2YXRlIG1ha2VVbmlmb3Jtcyhwcm9ncmFtVW5pZm9ybTogUHJvZ3JhbVVuaWZvcm0pOiBHUFVCaW5kaW5nUmVzb3VyY2Uge1xuICAgIGxldCBjdXJyZW50T2Zmc2V0ID0gMDtcbiAgICBsZXQgcHJlTGVuZ3RoID0gMDtcbiAgICBjb25zdCBvZmZzZXRzOiBudW1iZXJbXSA9IFtdO1xuICAgIGxldCBtYXhBbGlnbm1lbnRPZkZpZWxkID0gMTtcbiAgICBwcm9ncmFtVW5pZm9ybS5mb3JFYWNoKChkKSA9PiB7XG4gICAgICBpZiAoZC5kYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBkLmRhdGEgPSBbMV07XG4gICAgICB9XG4gICAgICAvLyBodHRwczovL3d3dy53My5vcmcvVFIvV0dTTC8jYWxpZ25vZlxuICAgICAgbGV0IGJhc2VBbGlnbm1lbnQ6IG51bWJlcjtcbiAgICAgIHN3aXRjaCAoZC5kYXRhLmxlbmd0aCkge1xuICAgICAgICBjYXNlIDE6XG4gICAgICAgICAgYmFzZUFsaWdubWVudCA9IDQ7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgMjpcbiAgICAgICAgICBiYXNlQWxpZ25tZW50ID0gODtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAzOlxuICAgICAgICAgIGJhc2VBbGlnbm1lbnQgPSAxNjtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSA0OlxuICAgICAgICAgIGJhc2VBbGlnbm1lbnQgPSAxNjtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSA1OlxuICAgICAgICAgIGJhc2VBbGlnbm1lbnQgPSAxNjtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSA2OlxuICAgICAgICAgIGJhc2VBbGlnbm1lbnQgPSAxNjtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB1dGlsLmFzc2VydChmYWxzZSwgKCkgPT4gYFVuc3VwcG9ydGVkICR7ZC5kYXRhLmxlbmd0aH1EIHNoYXBlYCk7XG4gICAgICB9XG5cbiAgICAgIGlmIChwcmVMZW5ndGggPT09IDUgfHwgcHJlTGVuZ3RoID09PSA2KSB7XG4gICAgICAgIGJhc2VBbGlnbm1lbnQgPSAxNjtcbiAgICAgIH1cbiAgICAgIGlmIChiYXNlQWxpZ25tZW50ID4gbWF4QWxpZ25tZW50T2ZGaWVsZCkge1xuICAgICAgICBtYXhBbGlnbm1lbnRPZkZpZWxkID0gYmFzZUFsaWdubWVudDtcbiAgICAgIH1cbiAgICAgIGN1cnJlbnRPZmZzZXQgPSBNYXRoLmNlaWwoY3VycmVudE9mZnNldCAvIGJhc2VBbGlnbm1lbnQpICogYmFzZUFsaWdubWVudDtcbiAgICAgIHByZUxlbmd0aCA9IGQuZGF0YS5sZW5ndGg7XG4gICAgICBvZmZzZXRzLnB1c2goY3VycmVudE9mZnNldCk7XG4gICAgICBjdXJyZW50T2Zmc2V0ICs9IGQuZGF0YS5sZW5ndGggKiA0O1xuICAgIH0pO1xuXG4gICAgY3VycmVudE9mZnNldCA9XG4gICAgICAgIE1hdGguY2VpbChjdXJyZW50T2Zmc2V0IC8gbWF4QWxpZ25tZW50T2ZGaWVsZCkgKiBtYXhBbGlnbm1lbnRPZkZpZWxkO1xuICAgIGNvbnN0IGFycmF5QnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKGN1cnJlbnRPZmZzZXQpO1xuICAgIHByb2dyYW1Vbmlmb3JtLmZvckVhY2goKGQsIGkpID0+IHtcbiAgICAgIGNvbnN0IG9mZnNldCA9IG9mZnNldHNbaV07XG4gICAgICBpZiAoZC50eXBlID09PSAnaW50MzInKSB7XG4gICAgICAgIG5ldyBJbnQzMkFycmF5KGFycmF5QnVmZmVyLCBvZmZzZXQsIGQuZGF0YS5sZW5ndGgpLnNldChkLmRhdGEpO1xuICAgICAgfSBlbHNlIGlmIChkLnR5cGUgPT09ICd1aW50MzInKSB7XG4gICAgICAgIG5ldyBVaW50MzJBcnJheShhcnJheUJ1ZmZlciwgb2Zmc2V0LCBkLmRhdGEubGVuZ3RoKS5zZXQoZC5kYXRhKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5ldyBGbG9hdDMyQXJyYXkoYXJyYXlCdWZmZXIsIG9mZnNldCwgZC5kYXRhLmxlbmd0aCkuc2V0KGQuZGF0YSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCB1bmlmb3JtQnVmZmVyID0gdGhpcy5idWZmZXJNYW5hZ2VyLmFjcXVpcmVCdWZmZXIoXG4gICAgICAgIGN1cnJlbnRPZmZzZXQsIEdQVUJ1ZmZlclVzYWdlLkNPUFlfRFNUIHwgR1BVQnVmZmVyVXNhZ2UuVU5JRk9STSk7XG4gICAgdGhpcy5xdWV1ZS53cml0ZUJ1ZmZlcih1bmlmb3JtQnVmZmVyLCAwLCBhcnJheUJ1ZmZlciwgMCwgY3VycmVudE9mZnNldCk7XG4gICAgdGhpcy51bmlmb3JtUGVuZGluZ0Rpc3Bvc2FsLnB1c2godW5pZm9ybUJ1ZmZlcik7XG5cbiAgICByZXR1cm4ge29mZnNldDogMCwgc2l6ZTogY3VycmVudE9mZnNldCwgYnVmZmVyOiB1bmlmb3JtQnVmZmVyfTtcbiAgfVxuXG4gIHB1YmxpYyBydW5XZWJHUFVQcm9ncmFtKFxuICAgICAgcHJvZ3JhbTogd2ViZ3B1X3Byb2dyYW0uV2ViR1BVUHJvZ3JhbSwgaW5wdXRzOiBUZW5zb3JJbmZvW10sXG4gICAgICBvdXRwdXREdHlwZTogRGF0YVR5cGUsIHByb2dyYW1EZWZpbmVkVW5pZm9ybT86IFByb2dyYW1Vbmlmb3JtLFxuICAgICAgb3V0cHV0PzogVGVuc29ySW5mbyk6IFRlbnNvckluZm8ge1xuICAgIGlmICghb3V0cHV0KSB7XG4gICAgICBvdXRwdXQgPSB0aGlzLm1ha2VUZW5zb3JJbmZvKHByb2dyYW0ub3V0cHV0U2hhcGUsIG91dHB1dER0eXBlKTtcbiAgICB9XG4gICAgaWYgKHV0aWwuc2l6ZUZyb21TaGFwZShvdXRwdXQuc2hhcGUpID09PSAwKSB7XG4gICAgICAvLyBTaG9ydC1jaXJjdWl0IHRoZSBjb21wdXRhdGlvbiBzaW5jZSB0aGUgcmVzdWx0IGlzIGVtcHR5IChoYXMgMCBpbiBpdHNcbiAgICAgIC8vIHNoYXBlKS5cbiAgICAgIHRoaXMudGVuc29yTWFwLmdldChvdXRwdXQuZGF0YUlkKS52YWx1ZXMgPVxuICAgICAgICAgIHV0aWwuZ2V0VHlwZWRBcnJheUZyb21EVHlwZShvdXRwdXQuZHR5cGUgYXMgJ2Zsb2F0MzInLCAwKTtcbiAgICAgIHJldHVybiBvdXRwdXQ7XG4gICAgfVxuICAgIHRoaXMudXBsb2FkVG9HUFUob3V0cHV0LmRhdGFJZCk7XG4gICAgcHJvZ3JhbS5kaXNwYXRjaCA9IHJlc2hhcGVEaXNwYXRjaCh0aGlzLmRldmljZSwgcHJvZ3JhbSk7XG5cbiAgICBjb25zdCBpbnB1dHNEYXRhID0gaW5wdXRzLm1hcCgoaW5wdXQ6IFRlbnNvckluZm8sIGk6IG51bWJlcikgPT4ge1xuICAgICAgaWYgKGlucHV0LmR0eXBlID09PSAnY29tcGxleDY0Jykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgR1BHUFVQcm9ncmFtIGRvZXMgbm90IHN1cHBvcnQgY29tcGxleDY0IGlucHV0LiBGb3IgY29tcGxleDY0IGAgK1xuICAgICAgICAgICAgYGR0eXBlcywgcGxlYXNlIHNlcGFyYXRlIHRoZSBwcm9ncmFtIGludG8gcmVhbCBhbmQgaW1hZ2luYXJ5IGAgK1xuICAgICAgICAgICAgYHBhcnRzLmApO1xuICAgICAgfVxuICAgICAgdGhpcy51cGxvYWRUb0dQVShpbnB1dC5kYXRhSWQpO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICAvLyBSZXR1cm5pbmcgZHR5cGUgZnJvbSB0ZW5zb3JNYXAgYmVjYXVzZSBpdCByZWZsZWN0cyBkdHlwZVxuICAgICAgICAvLyBvZiB1bmRlcmx5aW5nIGJ1ZmZlciwgcmF0aGVyIHRoYW4gYWJzdHJhY3QgZHR5cGUuXG4gICAgICAgIGR0eXBlOiB0aGlzLnRlbnNvck1hcC5nZXQoaW5wdXQuZGF0YUlkKS5kdHlwZSxcbiAgICAgICAgc2hhcGU6IGlucHV0LnNoYXBlLFxuICAgICAgICBuYW1lOiBwcm9ncmFtLnZhcmlhYmxlTmFtZXNbaV1cbiAgICAgIH07XG4gICAgfSk7XG5cbiAgICBwcm9ncmFtLnNoYWRlcktleSA9XG4gICAgICAgIHdlYmdwdV9wcm9ncmFtLm1ha2VTaGFkZXJLZXkocHJvZ3JhbSwgaW5wdXRzRGF0YSwgb3V0cHV0KTtcblxuICAgIGNvbnN0IHBhcmFsbGVsQ29tcGlsYXRpb24gPSBlbnYoKS5nZXRCb29sKCdXRUJHUFVfRU5HSU5FX0NPTVBJTEVfT05MWScpO1xuICAgIGlmICghKHByb2dyYW0uc2hhZGVyS2V5IGluIHRoaXMucGlwZWxpbmVDYWNoZSkpIHtcbiAgICAgIHRoaXMucGlwZWxpbmVDYWNoZVtwcm9ncmFtLnNoYWRlcktleV0gPSB3ZWJncHVfcHJvZ3JhbS5jb21waWxlUHJvZ3JhbShcbiAgICAgICAgICB0aGlzLmRldmljZSwgcHJvZ3JhbSwgaW5wdXRzRGF0YSwgb3V0cHV0LCBwYXJhbGxlbENvbXBpbGF0aW9uKTtcbiAgICB9XG4gICAgcHJvZ3JhbS5waXBlbGluZSA9IHRoaXMucGlwZWxpbmVDYWNoZVtwcm9ncmFtLnNoYWRlcktleV07XG5cbiAgICBpZiAoIXBhcmFsbGVsQ29tcGlsYXRpb24pIHtcbiAgICAgIHRoaXMucmVjb3JkQW5kU3VibWl0KHByb2dyYW0sIG91dHB1dCwgaW5wdXRzLCBwcm9ncmFtRGVmaW5lZFVuaWZvcm0pO1xuICAgIH1cbiAgICByZXR1cm4gb3V0cHV0O1xuICB9XG5cbiAgcHJpdmF0ZSByZWNvcmRBbmRTdWJtaXQoXG4gICAgICBwcm9ncmFtOiB3ZWJncHVfcHJvZ3JhbS5XZWJHUFVQcm9ncmFtLCBvdXRwdXQ6IFRlbnNvckluZm8sXG4gICAgICBpbnB1dHM6IFRlbnNvckluZm9bXSwgcHJvZ3JhbURlZmluZWRVbmlmb3JtPzogUHJvZ3JhbVVuaWZvcm0pIHtcbiAgICBpZiAocHJvZ3JhbS5waXBlbGluZSBpbnN0YW5jZW9mIFByb21pc2UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAnUGxlYXNlIGNhbGwgY2hlY2tDb21waWxlQ29tcGxldGlvbkFzeW5jIHRvIGVuc3VyZSBwYXJhbGxlbCBjb21waWxhdGlvbiBpcyBkb25lIScpO1xuICAgIH1cbiAgICAvLyBUaGVyZSBhcmUgc2l4IGtpbmRzIG9mIHVuaWZvcm1zOiBOQU4sIElORklOSVRZLCBzaGFwZXMsIHNoYXBlIHN0cmlkZXMsXG4gICAgLy8gcHJvZ3JhbSBzaXplLCBwcm9ncmFtIGRlZmluZWQgdW5pZm9ybXMuXG4gICAgbGV0IHByb2dyYW1Vbmlmb3JtOiBQcm9ncmFtVW5pZm9ybSA9IFtdO1xuICAgIGxldCBidWZmZXJTaGFwZXM6IG51bWJlcltdW10gPSBbXTtcbiAgICBjb25zdCB1bmlmb3Jtc1R5cGUgPSAnaW50MzInO1xuICAgIGlmIChwcm9ncmFtLnBpeGVsc09wVHlwZSA9PSBudWxsKSB7XG4gICAgICBwcm9ncmFtVW5pZm9ybS5wdXNoKFxuICAgICAgICAgIHt0eXBlOiAnZmxvYXQzMicsIGRhdGE6IFtOYU5dfSwge3R5cGU6ICdmbG9hdDMyJywgZGF0YTogW0luZmluaXR5XX0pO1xuICAgICAgYnVmZmVyU2hhcGVzID0gaW5wdXRzLmNvbmNhdChvdXRwdXQpLm1hcChkID0+IGQuc2hhcGUpO1xuICAgICAgY29uc3QgdW5pZm9ybXNUeXBlID0gJ2ludDMyJztcbiAgICAgIGJ1ZmZlclNoYXBlcy5tYXAoZCA9PiB7XG4gICAgICAgIHByb2dyYW1Vbmlmb3JtLnB1c2goe3R5cGU6IHVuaWZvcm1zVHlwZSwgZGF0YTogZH0pO1xuICAgICAgICBjb25zdCBzdHJpZGVzID0gdXRpbC5jb21wdXRlU3RyaWRlcyhkKTtcbiAgICAgICAgcHJvZ3JhbVVuaWZvcm0ucHVzaCh7dHlwZTogdW5pZm9ybXNUeXBlLCBkYXRhOiBzdHJpZGVzfSk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgc3RyaWRlcyA9IHV0aWwuY29tcHV0ZVN0cmlkZXMob3V0cHV0LnNoYXBlKTtcbiAgICAgIHByb2dyYW1Vbmlmb3JtLnB1c2goe3R5cGU6IHVuaWZvcm1zVHlwZSwgZGF0YTogc3RyaWRlc30pO1xuICAgIH1cbiAgICBpZiAocHJvZ3JhbS5zaXplKSB7XG4gICAgICBjb25zdCBzaXplID0gdXRpbC5zaXplRnJvbVNoYXBlKHByb2dyYW0ub3V0cHV0U2hhcGUpO1xuICAgICAgcHJvZ3JhbVVuaWZvcm0ucHVzaCh7XG4gICAgICAgIHR5cGU6IHVuaWZvcm1zVHlwZSxcbiAgICAgICAgZGF0YTogW3Byb2dyYW0ub3V0cHV0Q29tcG9uZW50ID8gc2l6ZSAvIHByb2dyYW0ub3V0cHV0Q29tcG9uZW50IDogc2l6ZV1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChwcm9ncmFtRGVmaW5lZFVuaWZvcm0pIHtcbiAgICAgIHByb2dyYW1Vbmlmb3JtID0gWy4uLnByb2dyYW1Vbmlmb3JtLCAuLi5wcm9ncmFtRGVmaW5lZFVuaWZvcm1dO1xuICAgIH1cbiAgICBjb25zdCBiaW5kaW5ncyA9IFtcbiAgICAgIHRoaXMudGVuc29yVG9CaW5kaW5nKG91dHB1dCksIC4uLmlucHV0cy5tYXAodCA9PiB0aGlzLnRlbnNvclRvQmluZGluZyh0KSksXG4gICAgICB0aGlzLm1ha2VVbmlmb3Jtcyhwcm9ncmFtVW5pZm9ybSlcbiAgICBdO1xuXG4gICAgaW5wdXRzLmZvckVhY2goaW5wdXQgPT4ge1xuICAgICAgdGhpcy5jb21tYW5kUXVldWVPd25lZElkcy5hZGQoaW5wdXQuZGF0YUlkKTtcbiAgICB9KTtcbiAgICB0aGlzLmNvbW1hbmRRdWV1ZU93bmVkSWRzLmFkZChvdXRwdXQuZGF0YUlkKTtcblxuICAgIGNvbnN0IGJpbmRHcm91cCA9IHRoaXMuZGV2aWNlLmNyZWF0ZUJpbmRHcm91cCh7XG4gICAgICBsYXlvdXQ6IHByb2dyYW0ucGlwZWxpbmUuZ2V0QmluZEdyb3VwTGF5b3V0KDApLFxuICAgICAgZW50cmllczogYmluZGluZ3MubWFwKChiLCBpKSA9PiAoe2JpbmRpbmc6IGksIHJlc291cmNlOiBifSkpLFxuICAgIH0pO1xuXG4gICAgY29uc3Qgc2hvdWxkVGltZVByb2dyYW0gPSB0aGlzLmFjdGl2ZVRpbWVycyAhPSBudWxsO1xuICAgIHRoaXMuZW5zdXJlQ29tbWFuZEVuY29kZXJSZWFkeSgpO1xuXG4gICAgY29uc3QgY29tcHV0ZVBhc3NEZXNjcmlwdG9yOiBHUFVDb21wdXRlUGFzc0Rlc2NyaXB0b3IgPSB7fTtcbiAgICBpZiAoc2hvdWxkVGltZVByb2dyYW0gJiYgdGhpcy5zdXBwb3J0VGltZXN0YW1wUXVlcnkpIHtcbiAgICAgIHRoaXMuZW5kQ29tcHV0ZVBhc3NFbmNvZGVyKCk7XG4gICAgICBpZiAodGhpcy5xdWVyeVNldCA9PSBudWxsKSB7XG4gICAgICAgIHRoaXMucXVlcnlTZXQgPSB0aGlzLmRldmljZS5jcmVhdGVRdWVyeVNldCh7XG4gICAgICAgICAgdHlwZTogJ3RpbWVzdGFtcCcsXG4gICAgICAgICAgY291bnQ6IHRoaXMucXVlcnlTZXRDb3VudCxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBjb21wdXRlUGFzc0Rlc2NyaXB0b3IudGltZXN0YW1wV3JpdGVzID0gW1xuICAgICAgICB7XG4gICAgICAgICAgcXVlcnlTZXQ6IHRoaXMucXVlcnlTZXQsXG4gICAgICAgICAgcXVlcnlJbmRleDogMCxcbiAgICAgICAgICBsb2NhdGlvbjogJ2JlZ2lubmluZycsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBxdWVyeVNldDogdGhpcy5xdWVyeVNldCxcbiAgICAgICAgICBxdWVyeUluZGV4OiAxLFxuICAgICAgICAgIGxvY2F0aW9uOiAnZW5kJyxcbiAgICAgICAgfVxuICAgICAgXTtcbiAgICAgIHRoaXMuY29tcHV0ZVBhc3NFbmNvZGVyID1cbiAgICAgICAgICB0aGlzLmNvbW1hbmRFbmNvZGVyLmJlZ2luQ29tcHV0ZVBhc3MoY29tcHV0ZVBhc3NEZXNjcmlwdG9yKTtcbiAgICB9IGVsc2UgaWYgKCF0aGlzLmNvbXB1dGVQYXNzRW5jb2Rlcikge1xuICAgICAgdGhpcy5jb21wdXRlUGFzc0VuY29kZXIgPVxuICAgICAgICAgIHRoaXMuY29tbWFuZEVuY29kZXIuYmVnaW5Db21wdXRlUGFzcyhjb21wdXRlUGFzc0Rlc2NyaXB0b3IpO1xuICAgIH1cblxuICAgIHRoaXMuY29tcHV0ZVBhc3NFbmNvZGVyLnNldFBpcGVsaW5lKHByb2dyYW0ucGlwZWxpbmUpO1xuICAgIHRoaXMuY29tcHV0ZVBhc3NFbmNvZGVyLnNldEJpbmRHcm91cCgwLCBiaW5kR3JvdXApO1xuICAgIHRoaXMuY29tcHV0ZVBhc3NFbmNvZGVyLmRpc3BhdGNoV29ya2dyb3VwcyhcbiAgICAgICAgcHJvZ3JhbS5kaXNwYXRjaFswXSwgcHJvZ3JhbS5kaXNwYXRjaFsxXSwgcHJvZ3JhbS5kaXNwYXRjaFsyXSk7XG4gICAgdGhpcy5kaXNwYXRjaENvdW50SW5QYXNzKys7XG5cbiAgICBpZiAoc2hvdWxkVGltZVByb2dyYW0gfHxcbiAgICAgICAgZW52KCkuZ2V0KCdXRUJHUFVfREVGRVJSRURfU1VCTUlUX0JBVENIX1NJWkUnKSBhc1xuICAgICAgICAgICAgbnVtYmVyIDw9IHRoaXMuZGlzcGF0Y2hDb3VudEluUGFzcyB8fFxuICAgICAgICBwcm9ncmFtLnBpeGVsc09wVHlwZSA9PT0gd2ViZ3B1X3Byb2dyYW0uUGl4ZWxzT3BUeXBlLkRSQVcpIHtcbiAgICAgIHRoaXMuZW5kQ29tcHV0ZVBhc3NFbmNvZGVyKCk7XG4gICAgICBpZiAoc2hvdWxkVGltZVByb2dyYW0pIHtcbiAgICAgICAgdGhpcy5hY3RpdmVUaW1lcnMucHVzaChcbiAgICAgICAgICAgIHtuYW1lOiBwcm9ncmFtLmNvbnN0cnVjdG9yLm5hbWUsIHF1ZXJ5OiB0aGlzLmdldFF1ZXJ5VGltZSgpfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnN1Ym1pdFF1ZXVlKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0UXVlcnlUaW1lKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgaWYgKCF0aGlzLnN1cHBvcnRUaW1lc3RhbXBRdWVyeSkge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucXVlcnlSZXNvbHZlQnVmZmVyID09IG51bGwpIHtcbiAgICAgIHRoaXMucXVlcnlSZXNvbHZlQnVmZmVyID0gdGhpcy5idWZmZXJNYW5hZ2VyLmFjcXVpcmVCdWZmZXIoXG4gICAgICAgICAgdGhpcy5xdWVyeVNldENvdW50ICogOCxcbiAgICAgICAgICBHUFVCdWZmZXJVc2FnZS5DT1BZX1NSQyB8IEdQVUJ1ZmZlclVzYWdlLkNPUFlfRFNUIHxcbiAgICAgICAgICAgICAgR1BVQnVmZmVyVXNhZ2UuUVVFUllfUkVTT0xWRSk7XG4gICAgfVxuICAgIHRoaXMuY29tbWFuZEVuY29kZXIucmVzb2x2ZVF1ZXJ5U2V0KFxuICAgICAgICB0aGlzLnF1ZXJ5U2V0LCAwLCB0aGlzLnF1ZXJ5U2V0Q291bnQsIHRoaXMucXVlcnlSZXNvbHZlQnVmZmVyLCAwKTtcblxuICAgIGNvbnN0IHF1ZXJ5U3RhZ2luZ0J1ZmZlciA9IHRoaXMuYnVmZmVyTWFuYWdlci5hY3F1aXJlQnVmZmVyKFxuICAgICAgICB0aGlzLnF1ZXJ5U2V0Q291bnQgKiA4LFxuICAgICAgICBHUFVCdWZmZXJVc2FnZS5NQVBfUkVBRCB8IEdQVUJ1ZmZlclVzYWdlLkNPUFlfRFNUKTtcblxuICAgIHRoaXMuY29tbWFuZEVuY29kZXIuY29weUJ1ZmZlclRvQnVmZmVyKFxuICAgICAgICB0aGlzLnF1ZXJ5UmVzb2x2ZUJ1ZmZlciwgMCwgcXVlcnlTdGFnaW5nQnVmZmVyLCAwLFxuICAgICAgICB0aGlzLnF1ZXJ5U2V0Q291bnQgKiA4KTtcblxuICAgIHRoaXMuc3VibWl0UXVldWUoKTtcblxuICAgIGF3YWl0IHF1ZXJ5U3RhZ2luZ0J1ZmZlci5tYXBBc3luYyhHUFVNYXBNb2RlLlJFQUQpO1xuICAgIGNvbnN0IGFycmF5QnVmZmVyID0gbmV3IEJpZ1VpbnQ2NEFycmF5KHF1ZXJ5U3RhZ2luZ0J1ZmZlci5nZXRNYXBwZWRSYW5nZSgpKTtcbiAgICBjb25zdCB0aW1lID0gTnVtYmVyKGFycmF5QnVmZmVyWzFdIC0gYXJyYXlCdWZmZXJbMF0pIC8gMTAwMDAwMDtcbiAgICBxdWVyeVN0YWdpbmdCdWZmZXIudW5tYXAoKTtcbiAgICB0aGlzLmJ1ZmZlck1hbmFnZXIucmVsZWFzZUJ1ZmZlcihxdWVyeVN0YWdpbmdCdWZmZXIpO1xuICAgIHJldHVybiB0aW1lO1xuICB9XG5cbiAgc2hvdWxkRXhlY3V0ZU9uQ1BVKFxuICAgICAgaW5wdXRzOiBUZW5zb3JJbmZvW10sXG4gICAgICBzaXplVGhyZXNob2xkID0gQ1BVX0hBTkRPRkZfU0laRV9USFJFU0hPTEQpOiBib29sZWFuIHtcbiAgICByZXR1cm4gZW52KCkuZ2V0Qm9vbCgnV0VCR1BVX0NQVV9GT1JXQVJEJykgJiZcbiAgICAgICAgaW5wdXRzLmV2ZXJ5KFxuICAgICAgICAgICAgaW5wdXQgPT4gdGhpcy50ZW5zb3JNYXAuZ2V0KGlucHV0LmRhdGFJZCkucmVzb3VyY2UgPT0gbnVsbCAmJlxuICAgICAgICAgICAgICAgIHV0aWwuc2l6ZUZyb21TaGFwZShpbnB1dC5zaGFwZSkgPCBzaXplVGhyZXNob2xkKTtcbiAgfVxuXG4gIG92ZXJyaWRlIG51bURhdGFJZHMoKSB7XG4gICAgcmV0dXJuIHRoaXMudGVuc29yTWFwLm51bURhdGFJZHMoKSAtIHRoaXMudGVuc29yRGF0YVBlbmRpbmdEaXNwb3NhbC5sZW5ndGg7XG4gIH1cblxuICBvdmVycmlkZSBkaXNwb3NlKCkge1xuICAgIGlmICh0aGlzLmRpc3Bvc2VkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLnF1ZXJ5U2V0ICE9IG51bGwpIHtcbiAgICAgIHRoaXMucXVlcnlTZXQuZGVzdHJveSgpO1xuICAgIH1cbiAgICB0aGlzLmJ1ZmZlck1hbmFnZXIuZGlzcG9zZSgpO1xuICAgIHRoaXMudGV4dHVyZU1hbmFnZXIuZGlzcG9zZSgpO1xuICAgIHRoaXMuZGlzcG9zZWQgPSB0cnVlO1xuICB9XG59XG4iXX0=
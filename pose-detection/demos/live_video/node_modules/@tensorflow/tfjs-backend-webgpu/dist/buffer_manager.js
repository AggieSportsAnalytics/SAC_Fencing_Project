/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
export class BufferManager {
    constructor(device) {
        this.device = device;
        this.numUsedBuffers = 0;
        this.numFreeBuffers = 0;
        this.freeBuffers = new Map();
        this.usedBuffers = new Map();
        this.numBytesUsed = 0;
        this.numBytesAllocated = 0;
    }
    acquireBuffer(size, usage, mappedAtCreation = false, reuse = true) {
        let buffer;
        const key = getBufferKey(size, usage);
        if (reuse) {
            if (!this.freeBuffers.has(key)) {
                this.freeBuffers.set(key, []);
            }
            if (this.freeBuffers.get(key).length > 0) {
                buffer = this.freeBuffers.get(key).pop();
                this.numFreeBuffers--;
            }
            else {
                buffer = this.device.createBuffer({ size, usage, mappedAtCreation });
                this.numBytesAllocated += size;
            }
        }
        else {
            buffer = this.device.createBuffer({ size, usage, mappedAtCreation });
            this.numBytesAllocated += size;
        }
        if (!this.usedBuffers.has(key)) {
            this.usedBuffers.set(key, []);
        }
        this.usedBuffers.get(key).push(buffer);
        this.numUsedBuffers++;
        this.numBytesUsed += size;
        return buffer;
    }
    releaseBuffer(buffer, reuse = true) {
        if (this.freeBuffers.size === 0) {
            return;
        }
        const size = buffer.size;
        const usage = buffer.usage;
        const key = getBufferKey(size, usage);
        const bufferArray = this.usedBuffers.get(key);
        const index = bufferArray.indexOf(buffer);
        if (index < 0) {
            throw new Error('Cannot find the buffer in buffer manager');
        }
        bufferArray[index] = bufferArray[bufferArray.length - 1];
        bufferArray.pop();
        this.numUsedBuffers--;
        this.numBytesUsed -= size;
        if (reuse) {
            this.freeBuffers.get(key).push(buffer);
            this.numFreeBuffers++;
        }
        else {
            buffer.destroy();
            this.numBytesAllocated -= size;
        }
    }
    getNumUsedBuffers() {
        return this.numUsedBuffers;
    }
    getNumFreeBuffers() {
        return this.numFreeBuffers;
    }
    dispose() {
        this.freeBuffers.forEach((buffers, key) => {
            buffers.forEach(buffer => {
                buffer.destroy();
            });
        });
        this.usedBuffers.forEach((buffers, key) => {
            buffers.forEach(buffer => {
                buffer.destroy();
            });
        });
        this.freeBuffers = new Map();
        this.usedBuffers = new Map();
        this.numUsedBuffers = 0;
        this.numFreeBuffers = 0;
        this.numBytesUsed = 0;
        this.numBytesAllocated = 0;
    }
}
function getBufferKey(size, usage) {
    return `${size}_${usage}`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVmZmVyX21hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi90ZmpzLWJhY2tlbmQtd2ViZ3B1L3NyYy9idWZmZXJfbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7QUFFSCxNQUFNLE9BQU8sYUFBYTtJQVN4QixZQUFvQixNQUFpQjtRQUFqQixXQUFNLEdBQU4sTUFBTSxDQUFXO1FBUjdCLG1CQUFjLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLG1CQUFjLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLGdCQUFXLEdBQTZCLElBQUksR0FBRyxFQUFFLENBQUM7UUFDbEQsZ0JBQVcsR0FBNkIsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUVuRCxpQkFBWSxHQUFHLENBQUMsQ0FBQztRQUNqQixzQkFBaUIsR0FBRyxDQUFDLENBQUM7SUFFVyxDQUFDO0lBRXpDLGFBQWEsQ0FDVCxJQUFZLEVBQUUsS0FBMEIsRUFBRSxnQkFBZ0IsR0FBRyxLQUFLLEVBQ2xFLEtBQUssR0FBRyxJQUFJO1FBQ2QsSUFBSSxNQUFNLENBQUM7UUFDWCxNQUFNLEdBQUcsR0FBRyxZQUFZLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXRDLElBQUksS0FBSyxFQUFFO1lBQ1QsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFO2dCQUM5QixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7YUFDL0I7WUFFRCxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQ3hDLE1BQU0sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztnQkFDekMsSUFBSSxDQUFD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QUFHLEVBQUUsRUFBRTtZQUN4QyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO2dCQUN2QixNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDbkIsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUM3QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUM7UUFDeEIsSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUM7UUFDeEIsSUFBSSxDQUFDLFlBQVksR0FBRyxDQUFDLENBQUM7UUFDdEIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLENBQUMsQ0FBQztJQUM3QixDQUFDO0NBQ0Y7QUFFRCxTQUFTLFlBQVksQ0FBQyxJQUFZLEVBQUUsS0FBMEI7SUFDNUQsT0FBTyxHQUFHLElBQUksSUFBSSxLQUFLLEVBQUUsQ0FBQztBQUM1QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgR29vZ2xlIExMQy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAqL1xuXG5leHBvcnQgY2xhc3MgQnVmZmVyTWFuYWdlciB7XG4gIHByaXZhdGUgbnVtVXNlZEJ1ZmZlcnMgPSAwO1xuICBwcml2YXRlIG51bUZyZWVCdWZmZXJzID0gMDtcbiAgcHJpdmF0ZSBmcmVlQnVmZmVyczogTWFwPHN0cmluZywgR1BVQnVmZmVyW10+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIHVzZWRCdWZmZXJzOiBNYXA8c3RyaW5nLCBHUFVCdWZmZXJbXT4gPSBuZXcgTWFwKCk7XG5cbiAgcHVibGljIG51bUJ5dGVzVXNlZCA9IDA7XG4gIHB1YmxpYyBudW1CeXRlc0FsbG9jYXRlZCA9IDA7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBkZXZpY2U6IEdQVURldmljZSkge31cblxuICBhY3F1aXJlQnVmZmVyKFxuICAgICAgc2l6ZTogbnVtYmVyLCB1c2FnZTogR1BVQnVmZmVyVXNhZ2VGbGFncywgbWFwcGVkQXRDcmVhdGlvbiA9IGZhbHNlLFxuICAgICAgcmV1c2UgPSB0cnVlKSB7XG4gICAgbGV0IGJ1ZmZlcjtcbiAgICBjb25zdCBrZXkgPSBnZXRCdWZmZXJLZXkoc2l6ZSwgdXNhZ2UpO1xuXG4gICAgaWYgKHJldXNlKSB7XG4gICAgICBpZiAoIXRoaXMuZnJlZUJ1ZmZlcnMuaGFzKGtleSkpIHtcbiAgICAgICAgdGhpcy5mcmVlQnVmZmVycy5zZXQoa2V5LCBbXSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmZyZWVCdWZmZXJzLmdldChrZXkpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgYnVmZmVyID0gdGhpcy5mcmVlQnVmZmVycy5nZXQoa2V5KS5wb3AoKTtcbiAgICAgICAgdGhpcy5udW1GcmVlQnVmZmVycy0tO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYnVmZmVyID0gdGhpcy5kZXZpY2UuY3JlYXRlQnVmZmVyKHtzaXplLCB1c2FnZSwgbWFwcGVkQXRDcmVhdGlvbn0pO1xuICAgICAgICB0aGlzLm51bUJ5dGVzQWxsb2NhdGVkICs9IHNpemU7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGJ1ZmZlciA9IHRoaXMuZGV2aWNlLmNyZWF0ZUJ1ZmZlcih7c2l6ZSwgdXNhZ2UsIG1hcHBlZEF0Q3JlYXRpb259KTtcbiAgICAgIHRoaXMubnVtQnl0ZXNBbGxvY2F0ZWQgKz0gc2l6ZTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMudXNlZEJ1ZmZlcnMuaGFzKGtleSkpIHtcbiAgICAgIHRoaXMudXNlZEJ1ZmZlcnMuc2V0KGtleSwgW10pO1xuICAgIH1cbiAgICB0aGlzLnVzZWRCdWZmZXJzLmdldChrZXkpLnB1c2goYnVmZmVyKTtcbiAgICB0aGlzLm51bVVzZWRCdWZmZXJzKys7XG4gICAgdGhpcy5udW1CeXRlc1VzZWQgKz0gc2l6ZTtcblxuICAgIHJldHVybiBidWZmZXI7XG4gIH1cblxuICByZWxlYXNlQnVmZmVyKGJ1ZmZlcjogR1BVQnVmZmVyLCByZXVzZSA9IHRydWUpIHtcbiAgICBpZiAodGhpcy5mcmVlQnVmZmVycy5zaXplID09PSAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3Qgc2l6ZSA9IGJ1ZmZlci5zaXplO1xuICAgIGNvbnN0IHVzYWdlID0gYnVmZmVyLnVzYWdlO1xuXG4gICAgY29uc3Qga2V5ID0gZ2V0QnVmZmVyS2V5KHNpemUsIHVzYWdlKTtcbiAgICBjb25zdCBidWZmZXJBcnJheSA9IHRoaXMudXNlZEJ1ZmZlcnMuZ2V0KGtleSk7XG4gICAgY29uc3QgaW5kZXggPSBidWZmZXJBcnJheS5pbmRleE9mKGJ1ZmZlcik7XG4gICAgaWYgKGluZGV4IDwgMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZmluZCB0aGUgYnVmZmVyIGluIGJ1ZmZlciBtYW5hZ2VyJyk7XG4gICAgfVxuICAgIGJ1ZmZlckFycmF5W2luZGV4XSA9IGJ1ZmZlckFycmF5W2J1ZmZlckFycmF5Lmxlbmd0aCAtIDFdO1xuICAgIGJ1ZmZlckFycmF5LnBvcCgpO1xuICAgIHRoaXMubnVtVXNlZEJ1ZmZlcnMtLTtcbiAgICB0aGlzLm51bUJ5dGVzVXNlZCAtPSBzaXplO1xuXG4gICAgaWYgKHJldXNlKSB7XG4gICAgICB0aGlzLmZyZWVCdWZmZXJzLmdldChrZXkpLnB1c2goYnVmZmVyKTtcbiAgICAgIHRoaXMubnVtRnJlZUJ1ZmZlcnMrKztcbiAgICB9IGVsc2Uge1xuICAgICAgYnVmZmVyLmRlc3Ryb3koKTtcbiAgICAgIHRoaXMubnVtQnl0ZXNBbGxvY2F0ZWQgLT0gc2l6ZTtcbiAgICB9XG4gIH1cblxuICBnZXROdW1Vc2VkQnVmZmVycygpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLm51bVVzZWRCdWZmZXJzO1xuICB9XG5cbiAgZ2V0TnVtRnJlZUJ1ZmZlcnMoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5udW1GcmVlQnVmZmVycztcbiAgfVxuXG4gIGRpc3Bvc2UoKSB7XG4gICAgdGhpcy5mcmVlQnVmZmVycy5mb3JFYWNoKChidWZmZXJzLCBrZXkpID0+IHtcbiAgICAgIGJ1ZmZlcnMuZm9yRWFjaChidWZmZXIgPT4ge1xuICAgICAgICBidWZmZXIuZGVzdHJveSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnVzZWRCdWZmZXJzLmZvckVhY2goKGJ1ZmZlcnMsIGtleSkgPT4ge1xuICAgICAgYnVmZmVycy5mb3JFYWNoKGJ1ZmZlciA9PiB7XG4gICAgICAgIGJ1ZmZlci5kZXN0cm95KCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHRoaXMuZnJlZUJ1ZmZlcnMgPSBuZXcgTWFwKCk7XG4gICAgdGhpcy51c2VkQnVmZmVycyA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLm51bVVzZWRCdWZmZXJzID0gMDtcbiAgICB0aGlzLm51bUZyZWVCdWZmZXJzID0gMDtcbiAgICB0aGlzLm51bUJ5dGVzVXNlZCA9IDA7XG4gICAgdGhpcy5udW1CeXRlc0FsbG9jYXRlZCA9IDA7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0QnVmZmVyS2V5KHNpemU6IG51bWJlciwgdXNhZ2U6IEdQVUJ1ZmZlclVzYWdlRmxhZ3MpIHtcbiAgcmV0dXJuIGAke3NpemV9XyR7dXNhZ2V9YDtcbn1cbiJdfQ==